<!doctype html>
<html lang="en">
<head>
  <title>Avaje</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="/images/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Source+Sans+Pro|Ubuntu|Kalam&display=swap">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/site.css">
  <link rel="stylesheet" href="/css/pygments.css">
</head>
<body>

<div class="container">
  <aside id="sidenav">
    <nav class="side scroll">
<ul>
  <li><a href="#overview">Overview</a>
</li>
<li><a href="#start">Getting started</a>
  <ul>
    <li><a href="#dependencies">Dependencies</a></li>
    <li><a href="#annotation-processor">Annotation processor</a></li>
    <li><a href="#first-controller">Controller</a></li>
    <li><a href="#main">Nima main()</a></li>
  </ul>
</li>
<li><a href="#testing">Testing Controllers</a>
    <ul>
      <li><a href="#testing">Injecting:</a></li>
      <li>- <a href="#inject-webserver">WebServer</a></li>
      <li>- <a href="#inject-httpclient">HttpClient</a></li>
      <li>- <a href="#inject-httpclient-builder">HttpClient.Builder</a></li>
      <li>- <a href="#inject-generated-client">Generated client</a></li>
    </ul>
</li>
<li><a href="#error-handlers">Error handlers</a>
    <ul>
      <li><a href="#error-example">Example</a></li>
      <li><a href="#error-testing">Testing Error Handler</a></li>
    </ul>
</li>
<li><a href="#filters">Filters</a>
</li>
<li><a href="#graalvm">GraalVM</a>
</li>
</ul>
<p>&nbsp;</p>
    </nav>
  </aside>
  <article id="main-content">
    <header>
      <nav id="top">
        <div class="breadcrumb"><a href="/">avaje</a><span class="sep">&nbsp;/&nbsp;</span><span class="last">nima</span></div>
        <ul>
          <li><a href="/" title="home"><i class="fas fa-home"></i></a></li>
          <li><a href="https://discord.gg/Qcqf9R27BR" title="discord server"><i class="fab fa-discord"></i></a></li>
          <li><a href="https://github.com/avaje/avaje-nima" title="github source"><i class="fab fa-github"></i></a></li>
          <li><a onclick="toggleTheme();" title="switch dark light theme"><i class="fas fa-adjust"></i></a></li>
        </ul>
      </nav>
    </header>
    
  <h1 id="overview">
    <span class="logo">Avaje</span>&thinsp;Nima
  </h1>

  <table style="width: 100%;">
    <tr>
      <th>Discord</th>
      <th>Source</th>
      <th>API Docs</th>
      <th>Issues</th>
      <th>Releases</th>
    </tr>
    <tr>
      <td><a href="https://discord.gg/Qcqf9R27BR">Discord</td>
      <td><a target="_blank" href="https://github.com/avaje/avaje-nima">GitHub</a></td>
      <td><a target="_blank"
          href="https://javadoc.io/doc/io.avaje/avaje-nima/latest/io.avaje.nima/io/avaje/nima/package-summary.html">Javadoc</a>
      </td>
      <td><a target="_blank" href="https://github.com/avaje/avaje-nima/issues">GitHub</a></td>
      <td><a href="https://github.com/avaje/avaje-nima/releases"><img
            src="https://img.shields.io/maven-central/v/io.avaje/avaje-nima.svg?label=Maven%20Central"></a></td>
    </tr>
  </table>

  <p><br><br>
    avaje-nima is a combination of Helidon SE Webserver and Avaje libraries, including:
  </p>
  <ul>
    <li><a href="https://helidon.io/#se">Helidon SE</a> - High performance webserver</li>
    <li><a href="/inject/">avaje-inject</a> - Dependency injection</li>
    <li><a href="/http/">avaje-http</a> - JAX-RS style controller generation</li>
    <li><a href="/jsonb/">avaje-jsonb</a> - JSON adapter generation</li>
    <li><a href="/validator/">avaje-validator</a> - Bean validation</li>
    <li><a href="/config/">avaje-config</a> - External configuration</li>
  </ul>
  <p>
    Avaje Nima uses annotation processors to generate the necessary code at compile time
    to wire up controllers, dependency injection, JSON adapters and validation.
    This results in a very lightweight runtime with minimal dependencies and no reflection,
    making it well suited for GraalVM native image applications.
  </p>

  <span id="start"></span>

  <h2 id="dependencies">Dependencies</h2>
  <h4>1. Add <em>avaje-nima</em> dependencies</h4>
  <div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>io.avaje<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>avaje-nima<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>&#36;{avaje.nima.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- test dependency --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>io.avaje<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>avaje-nima-test<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>&#36;{avaje.nima.version}<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>

  <h2 id="annotation-processor">Annotation processor</h2>
  <h4>2. Add the annotation processor</h4>
  <p>
    <code>avaje-nima-generator</code> is a composite of:
  </p>
  <ul>
    <li>avaje-http-helidon-generator - for the route adapter</li>
    <li>avaje-inject-generator - for dependency injection</li>
    <li>avaje-jsonb-generator - for json adapters</li>
    <li>avaje-validator-generator - for bean validation</li>
    <li>avaje-record-builder - for record builders</li>
    <li>avaje-spi-service - for automatic service generation</li>
    <li>jstachio-apt - for mustache template rendering</li>
    <li>avaje-http-client-generator - for test client generation</li>
  </ul>

  <div class="syntax xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Annotation processors --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>io.avaje<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>avaje-nima-generator<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>&#36;{avaje.nima.version}<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>

  <h4>2a. JDK 23+</h4>
  <p>
    In JDK 23+, annotation processors added as a provided dependency are disabled by default,
    so we need to add a compiler property to re-enable via:
  </p>
  <div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;properties&gt;</span>
  <span class="nt">&lt;maven.compiler.proc&gt;</span>full<span class="nt">&lt;/maven.compiler.proc&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
</pre></div>
</div>

  <h2 id="first-controller">Controller</h2>
  <p>
    Create a controller and annotate it with http-api annotations.
  </p>

  <div class="syntax java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.avaje.http.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.avaje.inject.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.avaje.jsonb.Json</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="o">{</span>

  <span class="nd">@Produces</span><span class="o">(</span><span class="s">&quot;text/plain&quot;</span><span class="o">)</span>
  <span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">)</span>
  <span class="n">String</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">&quot;hello world&quot;</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/json&quot;</span><span class="o">)</span>
  <span class="n">HelloBean</span> <span class="nf">helloJson</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">HelloBean</span><span class="o">(</span><span class="mi">97</span><span class="o">,</span> <span class="s">&quot;Hello JSON&quot;</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Json</span>
  <span class="kd">public</span> <span class="n">record</span> <span class="nf">HelloBean</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>


  <h2 id="main"><em>Nima</em> Class</h2>
  <p>
    The <em>Nima</em> class will start a <em>BeanScope</em>, register generated controller routes, and start the helidon webserver.
    <br/><br/>
    The <em>Nima</em> class will search your <em>BeanScope</em> for a <em>WebServerConfig.Builder</em>, if you provide one in your
    <em>BeanScope</em> it will be used to configure the webserver.
  </p>
  <div class="syntax java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.avaje.nima.Nima</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">var</span> <span class="n">webServer</span> <span class="o">=</span> <span class="n">Nima</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
      <span class="o">.</span><span class="na">port</span><span class="o">(</span><span class="mi">8080</span><span class="o">)</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="n">webServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
  <p>
    Now you can run the application main method,
  </p>
  <div class="syntax sh"><div class="highlight"><pre><span></span><span class="m">21</span>:23:37.951 <span class="o">[</span>main<span class="o">]</span> INFO  io.avaje.inject - Wired beans in 77ms
<span class="m">21</span>:23:38.001 <span class="o">[</span>features-thread<span class="o">]</span> INFO  i.h.common.features.HelidonFeatures - Helidon SE <span class="m">4</span>.2.2 features: <span class="o">[</span>Config, Encoding, Media, Metrics, Registry, WebServer<span class="o">]</span>
<span class="m">21</span>:23:38.005 <span class="o">[</span>start @default <span class="o">(</span>/0.0.0.0:8080<span class="o">)]</span> INFO  io.helidon.webserver.ServerListener - <span class="o">[</span>0x2132b530<span class="o">]</span> http://0.0.0.0:8080 bound <span class="k">for</span> socket <span class="s1">&#39;@default&#39;</span>
<span class="m">21</span>:23:38.008 <span class="o">[</span>main<span class="o">]</span> INFO  io.helidon.webserver.LoomServer - Started all channels in <span class="m">6</span> milliseconds. <span class="m">369</span> milliseconds since JVM startup. Java <span class="m">21</span>.0.5+9-LTS-239
  
</pre></div>
</div>
  <p>
    ... and perform a quick test using curl.
  </p>
  <div class="syntax sh"><div class="highlight"><pre><span></span>curl http://localhost:8080
hello world

curl http://localhost:8080/json
<span class="o">{</span><span class="s2">&quot;id&quot;</span>:97,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;Hello JSON&quot;</span><span class="o">}</span>
</pre></div>
</div>

  <h4>Generated code</h4>
  <p>
    After compiling, we should see in <code>target/generated-sources/annotations</code>:
  </p>
  <ul>
    <li><code>HelloController$DI</code> - which performs the dependency injection wiring of the controller</li>
    <li><code>HelloController$Route</code> - which registers the controller routes with Helidon and adapts the
      Helidon request and response to the controller code</li>
    <li><code>HelloController$Route$DI</code> - the dependency injection for the routes</li>
    <li><code>HelloController$HelloBeanJsonAdapter</code> - the JSON adapter for HelloBean</li>
  </ul>

  <h4>Generated test code</h4>
  <p>
    In <code>target/generated-test-sources/test-annotations</code>
    useful testing classes are generated for us:
  </p>
  <ul>
    <li><code>HelloControllerTestAPI</code> - a test client inteface to test the controller</li>
    <li><code>HelloControllerTestAPIHttpClient</code> - the test client implementation</li>
  </ul>

  <h2 id="testing">Testing Controllers</h2>
  <p>
    <code>avaje-nima-test</code> provides support for testing controllers which includes:
  </p>
  <ul>
    <li>Generating test clients for each controller</li>
    <li>Injecting Http Clients and Webserver into tests</li>
    <li>Starting webserver on a random port for any test with an injected Http Client</li>
  </ul>

  <h3>Test Injection</h3>
  <p>
    <code>avaje-nima-test</code> can inject dependencies into a test including
    Http Clients and the Helidon Webserver.
  </p>
  <ul>
    <li><code>io.avaje.http.client.HttpClient</code></li>
    <li><code>io.avaje.http.client.HttpClient.Builder</code></li>
    <li>A type annotated with <code>io.avaje.http.api.@Client</code> or <code>io.avaje.http.api.@Path</code></li>
  </ul>
  <p>
    When a test includes any of the above Http Client types to be injected,
    <code>avaje-nima-test</code> will automatically start a Helidon webserver
    on a random port for the test to use, and inject the Http Client(s) configured
    into the test (with the correct port to connect to the started webserver).
  </p>

  <h3 id="inject-webserver"><span>@Inject WebServer</span></h3>
  <p>
    We typically don't need to inject the <code>WebServer</code> unless we want to
    check the port or stop/start the server manually.
  </p>

  <details>
    <summary><code>example: @Inject WebServer</code></summary>
    <div class="syntax java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.avaje.http.client.HttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.avaje.inject.test.InjectTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.helidon.webserver.WebServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="o">;</span>

<span class="nd">@InjectTest</span>
<span class="kd">class</span> <span class="nc">MyControllerTest</span> <span class="o">{</span>

  <span class="nd">@Inject</span> <span class="nx">WebServer</span> <span class="nx">webServer</span><span class="o">;</span>
  <span class="nd">@Inject</span> <span class="nx">HttpClient</span> <span class="nx">httpClient</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kt">void</span> <span class="nf">testSomething</span><span class="o">()</span> <span class="o">{</span>

    <span class="c1">// webserver started on random port</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">webServer</span><span class="o">.</span><span class="na">port</span><span class="o">()).</span><span class="na">isNotEqualTo</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

    <span class="c1">// perform test using httpClient</span>
    <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">request</span><span class="o">().</span><span class="na">GET</span><span class="o">().</span><span class="na">asString</span><span class="o">();</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">statusCode</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">body</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;hello world&quot;</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
  </details>

  <h3 id="inject-httpclient"><span>@Inject HttpClient</span></h3>
  <p>
    We can inject the <code>HttpClient</code> to perform requests against the started webserver.
  </p>
  <details>
    <summary><code>example: @Inject HttpClient</code></summary>
    <div class="syntax java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.avaje.http.client.HttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.avaje.inject.test.InjectTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.helidon.webserver.WebServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="o">;</span>

<span class="nd">@InjectTest</span>
<span class="kd">class</span> <span class="nc">MyControllerTest</span> <span class="o">{</span>

  <span class="nd">@Inject</span> <span class="nx">HttpClient</span> <span class="nx">httpClient</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kt">void</span> <span class="nf">testSomething</span><span class="o">()</span> <span class="o">{</span>

    <span class="c1">// perform test using httpClient</span>
    <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">request</span><span class="o">().</span><span class="na">GET</span><span class="o">().</span><span class="na">asString</span><span class="o">();</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">statusCode</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">body</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;hello world&quot;</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
  </details>

  <h3 id="inject-httpclient-builder"><span>@Inject HttpClient.Builder</span></h3>
  <p>
    We can inject the <code>HttpClient.Builder</code> to perform requests against the started webserver.
    With the Builder we can customise the HttpClient as needed including things like setting the
    interceptors (that might automatically set http headers etc).
  </p>

  <details>
    <summary><code>example: @Inject HttpClient</code></summary>
    <p>
      For example lets say that we have a filter that requires a "Caller-Id" header to be set on each request,
      and we have a test configuration that sets a default Caller-Id for tests like:
    </p>
    <div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@TestScope</span>
<span class="nd">@Factory</span>
<span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>

    <span class="cm">/** Test clients by default will use this interceptor. */</span>
    <span class="nd">@Bean</span>
    <span class="n">HttpClient</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">httpClientBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">requestIntercept</span><span class="o">(</span><span class="k">new</span> <span class="n">RequestIntercept</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">beforeRequest</span><span class="o">(</span><span class="n">HttpClientRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">request</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;eroad-callerid&quot;</span><span class="o">,</span> <span class="s">&quot;local-test&quot;</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
    <p>
      We can inject the HttpClient.Builder so that we can change the interceptor for a specific test.
    </p>
    <div class="syntax java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.avaje.http.client.HttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.avaje.inject.test.InjectTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.helidon.webserver.WebServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="o">;</span>

<span class="nd">@InjectTest</span>
<span class="kd">class</span> <span class="nc">MyControllerTest</span> <span class="o">{</span>

  <span class="nd">@Inject</span> <span class="nx">HttpClient</span><span class="o">.</span><span class="na">Builder</span> <span class="nx">httpClientBuilder</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kt">void</span> <span class="nf">testSomething</span><span class="o">()</span> <span class="o">{</span>

    <span class="c1">// create a custom http client for this test</span>
    <span class="n">HttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="n">httpClientBuilder</span>
      <span class="o">.</span><span class="na">requestIntercept</span><span class="o">(</span><span class="n">request</span> <span class="o">-&gt;</span> <span class="n">request</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;eroad-callerid&quot;</span><span class="o">,</span> <span class="s">&quot;special-test&quot;</span><span class="o">))</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="c1">// perform test using httpClient</span>
    <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">request</span><span class="o">().</span><span class="na">GET</span><span class="o">().</span><span class="na">asString</span><span class="o">();</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">statusCode</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">body</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;hello world&quot;</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
  </details>

  <h3 id="inject-generated-client"><span>@Inject generated client</span></h3>
  <p>
    Given we have a <code>@Controller</code> called <code>HelloController</code> then there will
    automatically be a generated test client called <code>HelloControllerTestAPI</code> and we
    can inject that into our test. This allows us to use a type safe client to perform requests.
  </p>
  <details>
    <summary><code>example: @Inject generated client</code></summary>
    <div class="syntax java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.avaje.http.client.HttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.avaje.inject.test.InjectTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.helidon.webserver.WebServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import static</span> <span class="nn">org.assertj.core.api.Assertions.assertThat</span><span class="o">;</span>

<span class="nd">@InjectTest</span>
<span class="kd">class</span> <span class="nc">MyControllerTest</span> <span class="o">{</span>

  <span class="nd">@Inject</span> <span class="nx">HelloControllerTestAPI</span> <span class="nx">myClient</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kt">void</span> <span class="nf">testUsingGeneratedClient</span><span class="o">()</span> <span class="o">{</span>

    <span class="c1">// perform test using generated client API</span>
    <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">myClient</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">statusCode</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;hello world&quot;</span><span class="o">);</span>

    <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">HelloBean</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">myClient</span><span class="o">.</span><span class="na">helloJson</span><span class="o">();</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">statusCode</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>

    <span class="n">HelloBean</span> <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">();</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">body</span><span class="o">.</span><span class="na">id</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">97</span><span class="o">);</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">body</span><span class="o">.</span><span class="na">name</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;Hello JSON&quot;</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
  </details>


  <h2 id="error-handlers">Error handlers</h2>
  <p>
    Commonly exception handling is done in a dedicated exception handling class.
    This can be done by creating a controller that has <code>@ExceptionHandler</code> methods.
  </p>
  <p>
    The handler method:
  </p>
  <ul>
    <li>Takes an Exception type</li>
    <li>Optionally take a <code>ServerRequest</code></li>
    <li>Optionally take a <code>ServerResponse</code></li>
  </ul>
  <p>
    In terms of return type / error response body, the handler method can either:
  </p>
  <ul>
    <li>Return void, meaning the response should be explicitly set to the ServerResponse</li>
    <li>Return String, where the response is a <code>text/plain</code></li>
    <li>Return another type which is deemed a <code>@Json</code> Bean</li>
  </ul>

  <div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">ErrorHandlers</span> <span class="o">{</span>

  <span class="nd">@Produces</span><span class="o">(</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="o">...)</span>
  <span class="nd">@ExceptionHandler</span>
  <span class="n">SomeErrorResponse</span> <span class="nf">handler</span><span class="o">(</span><span class="n">SomeException</span> <span class="n">ex</span><span class="o">,</span> <span class="n">ServerRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">ServerResponse</span> <span class="n">res</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>

  <h3 id="error-example">Example error controller</h3>
  <div class="syntax java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.avaje.http.api.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.avaje.http.api.ExceptionHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.avaje.http.api.Produces</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.helidon.http.BadRequestException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.helidon.webserver.http.ServerRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">ErrorHandlers</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ErrorHandlers</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="nd">@Produces</span><span class="o">(</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">500</span><span class="o">)</span>
  <span class="nd">@ExceptionHandler</span>
  <span class="n">ErrorResponse</span> <span class="nf">defaultError</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">,</span> <span class="n">ServerRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">var</span> <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
    <span class="k">var</span> <span class="n">traceId</span> <span class="o">=</span> <span class="n">log</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">path</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">ErrorResponse</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
      <span class="o">.</span><span class="na">statusCode</span><span class="o">(</span><span class="mi">500</span><span class="o">)</span>
      <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="n">path</span><span class="o">)</span>
      <span class="o">.</span><span class="na">traceId</span><span class="o">(</span><span class="n">traceId</span><span class="o">)</span>
      <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="s">&quot;Unhandled server error&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Produces</span><span class="o">(</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">400</span><span class="o">)</span>
  <span class="nd">@ExceptionHandler</span>
  <span class="n">ErrorResponse</span> <span class="nf">badRequest</span><span class="o">(</span><span class="n">BadRequestException</span> <span class="n">ex</span><span class="o">,</span> <span class="n">ServerRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">var</span> <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
    <span class="k">var</span> <span class="n">traceId</span> <span class="o">=</span> <span class="n">log</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">path</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">ErrorResponse</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
      <span class="o">.</span><span class="na">statusCode</span><span class="o">(</span><span class="mi">400</span><span class="o">)</span>
      <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="n">path</span><span class="o">)</span>
      <span class="o">.</span><span class="na">traceId</span><span class="o">(</span><span class="n">traceId</span><span class="o">)</span>
      <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="s">&quot;Unhandled server error&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">path</span><span class="o">(</span><span class="n">ServerRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">req</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">.</span><span class="na">path</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">req</span><span class="o">.</span><span class="na">path</span><span class="o">().</span><span class="na">path</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="n">UUID</span> <span class="nf">log</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">,</span> <span class="n">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">UUID</span> <span class="n">traceId</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Unhandled server error path:{} trace:{}&quot;</span><span class="o">,</span> <span class="n">path</span><span class="o">,</span> <span class="n">traceId</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">traceId</span><span class="o">;</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
  <p>
    With the above example the error response has a JSON payload. The code for the
    <code>ErrorResponse</code> is:
  </p>
  <div class="syntax java"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io.avaje.jsonb.Json</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.avaje.recordbuilder.RecordBuilder</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="nd">@Json</span>
<span class="nd">@RecordBuilder</span>
<span class="kd">public</span> <span class="n">record</span> <span class="nf">ErrorResponse</span><span class="o">(</span>
  <span class="kt">int</span> <span class="n">statusCode</span><span class="o">,</span>
  <span class="n">String</span> <span class="n">path</span><span class="o">,</span>
  <span class="n">UUID</span> <span class="n">traceId</span><span class="o">,</span>
  <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="n">ErrorResponseBuilder</span> <span class="nf">builder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">ErrorResponseBuilder</span><span class="o">.</span><span class="na">builder</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
  <details>
    <summary>Generated Code: (click to expand) </summary>
    <div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Generated</span><span class="o">(</span><span class="s">&quot;avaje-helidon-generator&quot;</span><span class="o">)</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ErrorHandlers&#36;Route</span> <span class="kd">implements</span> <span class="n">HttpFeature</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">ErrorHandlers</span> <span class="n">controller</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">JsonType</span><span class="o">&lt;</span><span class="n">ErrorResponse</span><span class="o">&gt;</span> <span class="n">errorResponseJsonType</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">ErrorHandlers&#36;Route</span><span class="o">(</span><span class="n">ErrorHandlers</span> <span class="n">controller</span><span class="o">,</span> <span class="n">Jsonb</span> <span class="n">jsonb</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">controller</span> <span class="o">=</span> <span class="n">controller</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">errorResponseJsonType</span> <span class="o">=</span> <span class="n">jsonb</span><span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="n">ErrorResponse</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">(</span><span class="n">HttpRouting</span><span class="o">.</span><span class="na">Builder</span> <span class="n">routing</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">routing</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">_defaultError</span><span class="o">);</span>
    <span class="n">routing</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">BadRequestException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">_badRequest</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">_defaultError</span><span class="o">(</span><span class="n">ServerRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">ServerResponse</span> <span class="n">res</span><span class="o">,</span> <span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">res</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">INTERNAL_SERVER_ERROR_500</span><span class="o">);</span>
    <span class="k">var</span> <span class="n">result</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="na">defaultError</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">req</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">res</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">NO_CONTENT_204</span><span class="o">).</span><span class="na">send</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">res</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">contentType</span><span class="o">(</span><span class="n">MediaTypes</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">);</span>
      <span class="n">errorResponseJsonType</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">JsonOutput</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">res</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">_badRequest</span><span class="o">(</span><span class="n">ServerRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">ServerResponse</span> <span class="n">res</span><span class="o">,</span> <span class="n">BadRequestException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">res</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">BAD_REQUEST_400</span><span class="o">);</span>
    <span class="k">var</span> <span class="n">result</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="na">badRequest</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="n">req</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">res</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">NO_CONTENT_204</span><span class="o">).</span><span class="na">send</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">res</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">contentType</span><span class="o">(</span><span class="n">MediaTypes</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">);</span>
      <span class="n">errorResponseJsonType</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">JsonOutput</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">res</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
  </details>

  <h3 id="error-testing">Testing error handlers</h3>
  <p>
    We can test error handlers by injecting a test double that will invoke the error.
  </p>
  <p>
    With the test below, we use a test double for the <code>HelloController</code>
    that simulates a failure when the <code>hello()</code> method is called.
    This will cause the <code>defaultError(Exception, ServerRequest)</code> method
    in the <code>ErrorHandlers</code> controller to be invoked.
  </p>

  <div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@InjectTest</span>
<span class="kd">class</span> <span class="nc">HelloControllerErrorTest</span> <span class="o">{</span>

    <span class="nd">@Inject</span> <span class="nx">HelloControllerTestAPI</span> <span class="nx">api</span><span class="o">;</span>

    <span class="c1">// use test double in place of the real HelloController used by the server</span>
    <span class="nd">@Mock</span> <span class="nx">HelloController</span> <span class="nx">failingController</span> <span class="o">=</span> <span class="nx">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="nx">HelloController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>


    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">testHelloError_expect500</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// simulate failure in the service method</span>
        <span class="n">when</span><span class="o">(</span><span class="n">failingController</span><span class="o">.</span><span class="na">hello</span><span class="o">()).</span><span class="na">thenThrow</span><span class="o">(</span><span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&quot;Simulated failure&quot;</span><span class="o">));</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">api</span><span class="o">.</span><span class="na">hiMaybeError</span><span class="o">();</span>
            <span class="n">fail</span><span class="o">(</span><span class="s">&quot;Should have thrown HttpException...&quot;</span><span class="o">);</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">HttpException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// error response status code 500</span>
            <span class="n">assertThat</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">statusCode</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>

            <span class="c1">// if we know the error response body type we can convert to that</span>
            <span class="n">ErrorResponse</span> <span class="n">errorResponse</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">ErrorResponse</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">assertThat</span><span class="o">(</span><span class="n">errorResponse</span><span class="o">.</span><span class="na">path</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">&quot;/hello&quot;</span><span class="o">);</span>

            <span class="c1">// or just get the error body contents</span>
            <span class="n">String</span> <span class="n">errorBodyContent</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">bodyAsString</span><span class="o">();</span>
            <span class="n">assertThat</span><span class="o">(</span><span class="n">errorBodyContent</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;...&quot;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>


  <h2 id="filters">Filters</h2>
  <p>
    To add a Filter we can add a controller that has a <code>@Filter</code> method
    that takes a <code>FilterChain</code>, <code>RoutingRequest</code> and
    optionally a <code>RoutingResponse</code>.
  </p>
  <p>
    Example filter that reads a "Caller-Id" request header and rejects the
    request if one isn't provided.
  </p>
  <div class="syntax java"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io.avaje.http.api.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.avaje.http.api.Filter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.helidon.http.BadRequestException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.helidon.http.HeaderName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.helidon.http.HeaderNames</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.helidon.webserver.http.FilterChain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.helidon.webserver.http.RoutingRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.helidon.webserver.http.ServerRequest</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">CallerIdFilter</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">HeaderName</span> <span class="n">CALLER_ID</span> <span class="o">=</span> <span class="n">HeaderNames</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&quot;Caller-Id&quot;</span><span class="o">);</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">BYPASS</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;/ping&quot;</span><span class="o">);</span>

  <span class="nd">@Filter</span>
  <span class="kt">void</span> <span class="nf">filter</span><span class="o">(</span><span class="n">FilterChain</span> <span class="n">chain</span><span class="o">,</span> <span class="n">RoutingRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">var</span> <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">BYPASS</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">path</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">chain</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">callerId</span> <span class="o">=</span> <span class="n">callerId</span><span class="o">(</span><span class="n">req</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">BadRequestException</span><span class="o">(</span><span class="s">&quot;Caller-Id required&quot;</span><span class="o">));</span>
      <span class="n">handleCallerMetrics</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">callerId</span><span class="o">);</span>
      <span class="n">chain</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleCallerMetrics</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">,</span> <span class="n">String</span> <span class="n">callerId</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// capture metrics</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">callerId</span><span class="o">(</span><span class="n">RoutingRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">first</span><span class="o">(</span><span class="n">CALLER_ID</span><span class="o">);</span>
  <span class="o">}</span>


  <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">path</span><span class="o">(</span><span class="n">ServerRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">req</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="o">.</span><span class="na">path</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">req</span><span class="o">.</span><span class="na">path</span><span class="o">().</span><span class="na">path</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>

  <h2 id="graalvm">GraalVM native image</h2>
  <p>
    We can build GraalVM native images with Avaje Nima and the associated dependencies
    including Helidon SE webserver.
  </p>
  <p>
    The maven profile below builds a native executable and then builds a docker image
    for that native executable using a UBI micro base image with glibc.
  </p>
  <ul>
    <li><code>native-maven-plugin</code>: builds the native executable</li>
    <li><code>jib-maven-plugin</code>: builds a docker image including the native executable</li>
  </ul>

  <h4>maven profile - native image build</h4>
  <div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;profile&gt;</span>
  <span class="nt">&lt;id&gt;</span>native<span class="nt">&lt;/id&gt;</span>
  <span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
      <span class="nt">&lt;plugin&gt;</span> <span class="c">&lt;!-- build native executable --&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.graalvm.buildtools<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>native-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>0.11.3<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;extensions&gt;</span>true<span class="nt">&lt;/extensions&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;id&gt;</span>build-native<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>compile-no-fork<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;mainClass&gt;</span>org.example.Main<span class="nt">&lt;/mainClass&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
        <span class="nt">&lt;configuration&gt;</span>
          <span class="nt">&lt;buildArgs&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>--gc=G1<span class="nt">&lt;/buildArg&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>-R:MaxGCPauseMillis=50<span class="nt">&lt;/buildArg&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>-R:MaxHeapSize=400m<span class="nt">&lt;/buildArg&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>--emit build-report<span class="nt">&lt;/buildArg&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>--no-fallback<span class="nt">&lt;/buildArg&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>-march=compatibility<span class="nt">&lt;/buildArg&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>--allow-incomplete-classpath<span class="nt">&lt;/buildArg&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>--static-nolibc<span class="nt">&lt;/buildArg&gt;</span>
          <span class="nt">&lt;/buildArgs&gt;</span>
        <span class="nt">&lt;/configuration&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>

      <span class="nt">&lt;plugin&gt;</span> <span class="c">&lt;!-- build docker image for native executable --&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.google.cloud.tools<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jib-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>3.4.6<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>dockerBuild<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
        <span class="nt">&lt;dependencies&gt;</span>
          <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.google.cloud.tools<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>jib-native-image-extension-maven<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>0.1.0<span class="nt">&lt;/version&gt;</span>
          <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;/dependencies&gt;</span>

        <span class="nt">&lt;configuration&gt;</span>
          <span class="nt">&lt;pluginExtensions&gt;</span>
            <span class="nt">&lt;pluginExtension&gt;</span>
              <span class="nt">&lt;implementation&gt;</span>
                com.google.cloud.tools.jib.maven.extension.nativeimage.JibNativeImageExtension
              <span class="nt">&lt;/implementation&gt;</span>
              <span class="nt">&lt;properties&gt;</span> <span class="c">&lt;!-- name of executable produced --&gt;</span>
                <span class="nt">&lt;imageName&gt;</span>my-service<span class="nt">&lt;/imageName&gt;</span>
              <span class="nt">&lt;/properties&gt;</span>
            <span class="nt">&lt;/pluginExtension&gt;</span>
          <span class="nt">&lt;/pluginExtensions&gt;</span>
          <span class="nt">&lt;container&gt;</span>
            <span class="nt">&lt;mainClass&gt;</span>org.example.Main<span class="nt">&lt;/mainClass&gt;</span>
            <span class="nt">&lt;ports&gt;</span>8080<span class="nt">&lt;/ports&gt;</span>
          <span class="nt">&lt;/container&gt;</span>
          <span class="nt">&lt;from&gt;</span> <span class="c">&lt;!-- UBI micro base image with glibc --&gt;</span>
            <span class="nt">&lt;image&gt;</span>redhat/ubi10-micro:10.1-1762215812<span class="nt">&lt;/image&gt;</span>
          <span class="nt">&lt;/from&gt;</span>
          <span class="nt">&lt;to&gt;</span>
            <span class="nt">&lt;image&gt;</span>&#36;{project.artifactId}-native:&#36;{project.version}<span class="nt">&lt;/image&gt;</span>
          <span class="nt">&lt;/to&gt;</span>
        <span class="nt">&lt;/configuration&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/profile&gt;</span>
</pre></div>
</div>

  <h4>MacOS specific profile</h4>
  <p>
    MacOS does not support G1 garbage collector in native images, so we need to
    create a specific profile for MacOS builds that omits the G1 related build args.
  </p>
  <div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;profile&gt;</span>
  <span class="nt">&lt;id&gt;</span>mac<span class="nt">&lt;/id&gt;</span>
  <span class="nt">&lt;activation&gt;</span>
    <span class="nt">&lt;os&gt;</span>
      <span class="nt">&lt;family&gt;</span>mac<span class="nt">&lt;/family&gt;</span>
    <span class="nt">&lt;/os&gt;</span>
  <span class="nt">&lt;/activation&gt;</span>
  <span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
      <span class="nt">&lt;plugin&gt;</span> <span class="c">&lt;!-- native build on MacOS --&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.graalvm.buildtools<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>native-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;configuration&gt;</span>
          <span class="nt">&lt;buildArgs&gt;</span> <span class="c">&lt;!-- No G1 on MacOS native image --&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>-R:MaxHeapSize=400m<span class="nt">&lt;/buildArg&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>--emit build-report<span class="nt">&lt;/buildArg&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>--no-fallback<span class="nt">&lt;/buildArg&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>-march=compatibility<span class="nt">&lt;/buildArg&gt;</span>
            <span class="nt">&lt;buildArg&gt;</span>--static-nolibc<span class="nt">&lt;/buildArg&gt;</span>
          <span class="nt">&lt;/buildArgs&gt;</span>
        <span class="nt">&lt;/configuration&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/profile&gt;</span>
</pre></div>
</div>


  <p><br><br><br><br><br><br></p>

  </article>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="/js/site.js"></script>
</body>
</html>
