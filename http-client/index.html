<!doctype html>
<html lang="en">
<head>
  <title>Avaje</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="/images/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Source+Sans+Pro|Ubuntu&display=swap">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/site.css">
  <link rel="stylesheet" href="/css/pygments.css">
</head>
<body>

<div class="container">
  <aside id="sidenav">
    <nav class="side scroll">
<ul>
  <li><a href="#overview">Overview</a>
</li>
<li><a href="#getting-started">Getting started</a>
</li>
<li><a href="#dependencies">Dependencies</a>
</li>
<li><a href="#limitations">Limitations</a>
</li>
<li><a href="#quick-overview">Quick Overview</a>
</li>
<li><a href="#sync-async">Sync and Async</a>
</li>
<li><a href="#httpClientContext">HttpClient</a>
</li>
<li><a href="#json-bodyAdapter">JSON BodyAdapter</a>
    <ul>
      <li><a href="#json-jsonb">Avaje-Jsonb</a></li>
      <li><a href="#json-jackson">Jackson</a></li>
      <li><a href="#json-gson">Gson</a></li>
    </ul>
</li>
<li><a href="#request-body">Request Body</a>
    <ul>
      <li><a href="#req-json">Object JSON</a></li>
      <li><a href="#req-formparam">formParam</a></li>
      <li><a href="#req-path">path (file)</a></li>
      <li><a href="#req-inputStream">inputStream</a></li>
      <li><a href="#req-bodyPublisher">bodyPublisher</a></li>
    </ul>
</li>
<li><a href="#response-body">Response body</a>
    <ul>
      <li><a href="#bean">bean</a></li>
      <li><a href="#list">list</a></li>
      <li><a href="#stream">stream</a></li>
      <li><a href="#asVoid">void</a></li>
      <li><a href="#asDiscarding">discarding</a></li>
      <li><a href="#asString">string</a></li>
      <li><a href="#as">as</a></li>
      <li><a href="#withHandler">withHandler</a></li>
    </ul>
</li>
<li><a href="#httpException">HttpException</a>
    <ul>
      <li><a href="#error-mapping">Exception Mapping</a></li>
    </ul>
</li>

<li><a href="#async">Async</a>
    <ul>
      <li><a href="#async-join">testing with join</a></li>
      <li><a href="#async-executor">Executor</a></li>
    </ul>
</li>
<li><a href="#httpCall">HttpCall</a>
</li>
<li><a href="#retry">Retry</a>
</li>
<li><a href="#auth">Authorization</a>
    <ul>
      <li><a href="#auth-basic">basic auth</a></li>
      <li><a href="#auth-bearer">bearer token</a></li>
    </ul>
</li>
<li><a href="#logging">Logging</a>
    <ul>
      <li><a href="#logging-summary">summary</a></li>
      <li><a href="#logging-body">detail</a></li>
    </ul>
</li>
<li><a href="#client-api">Client API</a>
    <ul>
      <li><a href="#at-client">@Client</a></li>
      <li><a href="#at-client-import">@Client.Import</a></li>
      <li><a href="#obtain-api">Obtain API</a></li>
      <li><a href="#generated-api">Generated source</a></li>
      <li><a href="#api-response-types">Response types</a></li>
      <li><a href="#api-response-body">BodyHandler</a></li>
      <li><a href="#api-request-body">BodyPublisher</a></li>
      <li><a href="#path">@Path</a></li>
      <li><a href="#pathParameters">Path parameters</a></li>
      <li><a href="#timeout">@RequestTimeout</a></li>
      <li><a href="#header">@Header</a></li>
      <li><a href="#queryParam">@QueryParam</a></li>
      <li><a href="#bodystring">@BodyString</a></li>
      <li><a href="#beanParam">@BeanParam</a></li>
      <li><a href="#form">@Form</a></li>
      <li><a href="#formParam">@FormParam</a></li>
      <li><a href="#formBeans">Form beans</a></li>
    </ul>
</li>
<li><a href="#jpms">Java Modules</a>
</li>
<li><a href="#10k">10k requests & Loom</a>
    <ul>
      <li><a href="#10k-async">async</a></li>
      <li><a href="#10k-loom">loom</a></li>
    </ul
</li>
</ul>
<p>&nbsp;</p>
    </nav>
  </aside>
  <article id="main-content">
    <header>
      <nav id="top">
        <div class="breadcrumb"><a href="/">avaje</a><span class="sep">&nbsp;/&nbsp;</span><a href="/http">http</a><span class="sep">&nbsp;/&nbsp;</span><span class="last">client</span></div>
        <ul>
          <li><a href="/" title="home"><i class="fas fa-home"></i></a></li>
          <li><a href="https://github.com/avaje/avaje-http/tree/master/http-client" title="github source"><i class="fab fa-github"></i></a></li>
          <li><a onclick="toggleTheme();" title="switch dark light theme"><i class="fas fa-adjust"></i></a></li>
        </ul>
      </nav>
    </header>
    

<h1 id="overview">Avaje Http Client</h1>

<table style="width: 100%;">
  <tr>
    <th>License</th>
    <th>Source</th>
    <th>API Docs</th>
    <th>Issues</th>
    <th>Releases</th>
  </tr>
  <tr>
    <td><a target="_blank" href="https://github.com/avaje/avaje-http-client/blob/master/LICENSE">Apache2</a></td>
    <td><a target="_blank" href="https://github.com/avaje/avaje-http/tree/master/http-client">Github</a></td>
    <td><a target="_blank" href="/apidocs/avaje-http-client">Javadoc</a></td>
    <td><a target="_blank" href="https://github.com/avaje/avaje-http/issues">Github</a></td>
    <td><a href="https://github.com/avaje/avaje-http/releases"><img src="https://img.shields.io/maven-central/v/io.avaje/avaje-http-client.svg?label=Maven%20Central"></a></td>
  </tr>
</table>

<p>
  <br>
  A lightweight wrapper to the <a target="_blank" href="http://openjdk.java.net/groups/net/httpclient/intro.html">JDK 11+ Java Http Client</a>.
</p>
<ul>
  <li>Requires Java 11+</li>
  <li>Adds a fluid API for building URLs and payloads</li>
  <li>Adds JSON marshalling/unmarshalling of request and response using
    <a href="https://github.com/FasterXML/jackson">Jackson</a>,
    <a href="https://github.com/google/gson">Gson</a> or <a href="https://github.com/avaje/avaje-jsonb">avaje-jsonb</a>
  </li>
  <li>Gzip encoding/decoding</li>
  <li>Logging of request/response logging</li>
  <li>Interception of request/response</li>
  <li>Built in support for authorization via Basic Auth and Bearer Tokens</li>
  <li>Provides async and sync API</li>
</ul>

<h3 id="jdk-intro">JDK HttpClient Introduction</h3>
<p>
  Some introductions to the JDK HttpClient:
</p>
<ul>
  <li>OpenJDK HttpClient <a target="_blank" href="http://openjdk.java.net/groups/net/httpclient/intro.html">Introduction</a></li>
  <li>A closer look at the <a target="_blank" href="https://golb.hplar.ch/2019/01/java-11-http-client.html">Java 11 HTTP Client</a></li>
  <li>Javadoc for <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpClient.html">JDK HttpClient</a> </li>
</ul>

<h3>Client API generation</h3>
<p>
  We can define a java interface with annotations and have a Java
  annotation processor generate the client implementation (similar to Retrofit,
  Feign and JAX-RS client).
</p>
<ul>
  <li>Generates the implementation as source code via annotation processing</li>
  <li>No reflection and no use of dynamic proxies</li>
  <li>Targets <em>avaje-http-client / JDK HttpClient</em> only</li>
</ul>
<p>
  This client API generation targets <em>avaje-http-client / JDK HttpClient</em> only
  and uses source code generation via annotation processing so there is no use of reflection/dynamic proxies to slow things down.
</p>

<h5>Example client API</h5>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Client</span>
<span class="kd">interface</span> <span class="nc">GitHub</span> <span class="o">{</span>

  <span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/repos/{owner}/{repo}/contributors&quot;</span><span class="o">)</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Contributor</span><span class="o">&gt;</span> <span class="nf">contributors</span><span class="o">(</span><span class="n">String</span> <span class="n">owner</span><span class="o">,</span> <span class="n">String</span> <span class="n">repo</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>

<h5>Using client API</h5>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="s">&quot;https://api.github.com&quot;</span><span class="o">)</span>
  <span class="c1">//.bodyAdapter(new JsonbBodyAdapter())</span>
  <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="c1">// obtain API implementation</span>
<span class="n">GitHub</span> <span class="n">github</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">GitHub</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="k">try</span> <span class="o">{</span>
  <span class="c1">// use the api/interface</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Contributor</span><span class="o">&gt;</span> <span class="n">contributors</span> <span class="o">=</span> <span class="n">github</span><span class="o">.</span><span class="na">contributors</span><span class="o">(</span><span class="s">&quot;rbygrave&quot;</span><span class="o">,</span> <span class="s">&quot;junk&quot;</span><span class="o">);</span>

<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">HttpException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getCause</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// some IO/Interrupted exception happened while sending request.</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">//Use HttpException utility methods to access response status and handle/deserialize error body</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>

<h5>API allowing async or sync use via HttpCall</h5>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Client</span>
<span class="kd">interface</span> <span class="nc">GitHub</span> <span class="o">{</span>

  <span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/repos/{owner}/{repo}/contributors&quot;</span><span class="o">)</span>
  <span class="n">HttpCall</span><span class="o">&lt;</span><span class="n">Contributor</span><span class="o">&gt;</span> <span class="nf">contributors</span><span class="o">(</span><span class="n">String</span> <span class="n">owner</span><span class="o">,</span> <span class="n">String</span> <span class="n">repo</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>

<h2 id="getting-started">Getting started</h2>
<ul>
  <li><a href="/http-client/start">Get started with the base client</a></li>
  <li><a href="/http-client/start#api-start">Get started with Client API generation</a></li>
</ul>

<h2 id="dependencies">Dependencies</h2>

<h3 id="maven">Maven</h3>
<p>
  Add <em>avaje-http-client</em> as a dependency.
</p>
<div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>io.avaje<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>avaje-http-client<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>&#36;{avaje.http.client.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>

<h4>Client API generation</h4>
<p>
  For the client API generation, we need to add <em>avaje-http-api</em> as a dependency.
</p>
<div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>io.avaje<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>avaje-http-api<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>&#36;{avaje.http.api.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>

<h4>Client API - Annotation processor</h4>
<p>
  Add the <em>avaje-http-client-generator</em> annotation processor.
</p>
<div class="syntax xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Annotation processors --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>io.avaje<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>avaje-http-client-generator<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>&#36;{avaje.http.api.version}<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>

<h3 id="gradle">Gradle</h3>
<p>
  Add dependencies for <em>avaje-http-client</em> and <em>jackson-databind</em>.
</p>
<div class="syntax groovy"><div class="highlight"><pre><span></span><span class="n">dependencies</span> <span class="o">{</span>

  <span class="n">implementation</span> <span class="s1">&#39;com.fasterxml.jackson.core:jackson-databind:2.14.2&#39;</span>
  <span class="n">implementation</span> <span class="s1">&#39;io.avaje:avaje-http-client:1.35&#39;</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>

<p>
  When using Client API we additionally need <em>avaje-http-api</em> and the
  <em>avaje-http-client-generator</em> annotation processor.
</p>
<div class="syntax groovy"><div class="highlight"><pre><span></span><span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">implementation</span> <span class="s1">&#39;io.avaje:avaje-http-client:1.35&#39;</span>

    <span class="n">implementation</span> <span class="s1">&#39;io.avaje:avaje-http-api:1.17&#39;</span>
    <span class="n">annotationProcessor</span> <span class="s1">&#39;io.avaje:avaje-http-client-generator:1.35&#39;</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>


<h3 id="limitations">Limitations</h3>
<p>
  Current notable limitations are:
</p>
<ul>
  <li>No built-in support for multipart-form body (Though some <a href="https://github.com/yskszk63/jnhttp-multipartformdata-bodypublisher">libraries</a> provide bodyPublishers that can be used to send multi-part data)</li>
</ul>

<h3 id="quick-overview">Quick Overview</h3>

<h4>HttpClient</h4>
<p>
  Create an HttpClient with a base URL and BodyAdapter (plus other options as necessary like retry,
  interceptors etc). It can be used to create requests. Requests can be executed synchronously or asynchronously with
  CompletableFuture.
</p>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="n">baseUrl</span><span class="o">)</span>
  <span class="o">.</span><span class="na">bodyAdapter</span><span class="o">(</span><span class="k">new</span> <span class="n">JsonbBodyAdapter</span><span class="o">())</span>
  <span class="c1">//.bodyAdapter(new JacksonBodyAdapter())</span>
  <span class="c1">//.bodyAdapter(new GsonBodyAdapter(new Gson()))</span>
  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>

<h4>Example GET</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">Customer</span> <span class="n">customer</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;customers/42&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span> <span class="n">products</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;products&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;health&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">();</span>
</pre></div>
</div>

<h4>Example GET Async</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
 <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
 <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
 <span class="o">.</span><span class="na">async</span><span class="o">().</span><span class="na">asString</span><span class="o">()</span>  <span class="c1">// CompletableFuture&lt;HttpResponse&lt;String&gt;&gt;</span>
 <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">hres</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="c1">// CompletionException</span>
     <span class="o">...</span>
   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
     <span class="c1">// HttpResponse&lt;String&gt;</span>
     <span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">hres</span><span class="o">.</span><span class="na">statusCode</span><span class="o">();</span>
     <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="n">hres</span><span class="o">.</span><span class="na">body</span><span class="o">();</span>
     <span class="o">...</span>
   <span class="o">}</span>
 <span class="o">});</span>
</pre></div>
</div>


<h2 id="sync-async">Sync and Async</h2>
<p>
  We can make requests in simple blocking manner or via <code>async()</code>
  which uses <code>CompletableFuture</code>.
</p>
<p>
  The JDK HttpClient provides a number of <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpResponse.BodyHandler.html">BodyHandlers</a>
  including reactive Flow based subscribers. When executing the requests in
  asynchronous style the responses are processed in a reactive way. Generally
  <code>CompletableFuture.whenComplete()</code> will be called only when the
  response is ready.
</p>
<p>
  Using <a href="#withHandler">withHandler(...)</a> we can use any of the existing handlers or make our own
  <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpResponse.BodyHandler.html">HttpResponse.BodyHandler</a>
  implementation.
</p>

<h3>Loom vs Async</h3>
<p>
  With Loom we will be able to use simple blocking requests and get a similar
  performance as the <code>async()</code> requests. This is an important factor
  to keep in mind. To use loom, simply add a virtual thread executor to the http client builder.
</p>
<p>
  See <a href="#10k">10K requests - Loom vs Async</a>
</p>

<h2 id="httpClientContext">HttpClient</h2>
<p>
  HttpClient is effectively a wrapper of <code>java.net.http.HttpClient</code>
  with extra features for request interception, body adapters, retry, etc.
</p>
<p>
  Create a HttpClient with a base URL and a BodyAdapter (e.g. JsonbBodyAdapter). Set other options like retry and request interceptors as necessary.
</p>

<p>
  Reference <a target="_blank" href="/apidocs/avaje-http-client/io.avaje.http.client/io/avaje/http/client/HttpClient.Builder.html">HttpClient.Builder</a>
</p>

<h4>Creating HttpClient</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="n">baseUrl</span><span class="o">)</span>
  <span class="o">.</span><span class="na">bodyAdapter</span><span class="o">(</span><span class="k">new</span> <span class="n">JsonbBodyAdapter</span><span class="o">())</span>
  <span class="c1">// .bodyAdapter(new JacksonBodyAdapter())</span>
  <span class="c1">// .bodyAdapter(new GsonBodyAdapter(new Gson()))</span>
  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>
  From the HttpClient instance we create requests and execute them.
</p>
<h4>Create and execute requests</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">();</span>
</pre></div>
</div>

<h2 id="json-bodyAdapter">Json - BodyAdapter</h2>
<p>
  <em>avaje-http-client</em> provides a
  <a target="_blank" href="/apidocs/avaje-http-client/io.avaje.http.client/io/avaje/http/client/BodyAdapter.html">BodyAdapter</a> interface
  with implementations for <a href="https://github.com/FasterXML/jackson">Jackson</a>,
  <a href="https://github.com/google/gson">Gson</a> and <a href="https://github.com/avaje/avaje-jsonb">Avaje-Jsonb</a> to
  adapt request and response body content from JSON to java types and from java types to JSON.
</p>

<h3 id="json-jsonb">Using Avaje-Jsonb</h3>
<p>
  To use <em>avaje-jsonb</em> for serialization of request and response body content to and from JSON we need to:
</p>
<h4>1. Add avaje-jsonb dependency</h4>
<div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>io.avaje<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>avaje-jsonb<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>&#36;{avaje.jsonb.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>

<h4>2. Register JsonbBodyAdapter</h4>
<p>
  Register the JsonbBodyAdapter with the HttpClient builder. We can supply a jsonb instance
  to JsonbBodyAdapter or just use defaults. For example:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">Jsonb</span> <span class="n">jsonb</span> <span class="o">=</span> <span class="n">Jsonb</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>

<span class="n">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="n">baseUrl</span><span class="o">)</span>
  <span class="o">.</span><span class="na">bodyAdapter</span><span class="o">(</span><span class="k">new</span> <span class="n">JsonbBodyAdapter</span><span class="o">(</span><span class="n">jsonb</span><span class="o">))</span>
  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>
  <a href="https://github.com/avaje/avaje-jsonb">Avaje-jsonb</a> uses APT source code generation to generate
  adapters for types annotated with <code>@Json</code>. This makes it a fast and light dependency, especially good for
  http clients, CLI applications and use with GraalVM native images.
</p>

<h3 id="json-jackson">Using Jackson</h3>
<p>
  To use Jackson for serialization of request/response body content to/from JSON we need to:
</p>
<h4>1. Add jackson-databind dependency</h4>
<div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.14.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>

<h4>2. Register JacksonBodyAdapter</h4>
<p>
  Register a JacksonBodyAdapter with the HttpClient builder. We cab provide JacksonBodyAdapter an
  ObjectMapper that has modules and configuration. For example:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">().</span><span class="na">registerModule</span><span class="o">(</span><span class="k">new</span> <span class="n">JavaTimeModule</span><span class="o">());</span>

<span class="n">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="n">baseUrl</span><span class="o">)</span>
  <span class="o">.</span><span class="na">bodyAdapter</span><span class="o">(</span><span class="k">new</span> <span class="n">JacksonBodyAdapter</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">))</span>
  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="json-gson">Using Gson</h3>
<p>
  To use Gson for serialization of request/response body content to/from JSON we need to:
</p>
<h4>1. Add gson dependency</h4>
<div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.google.code.gson<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>gson<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.8.9<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>

<h4>2. Register GsonBodyAdapter</h4>
<p>
  Register the GsonBodyAdapter with the HttpClient builder. For example:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="n">baseUrl</span><span class="o">)</span>
  <span class="o">.</span><span class="na">bodyAdapter</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonBodyAdapter</span><span class="o">(</span><span class="k">new</span> <span class="n">Gson</span><span class="o">()))</span>
  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>

<h2 id="request-body">Request body</h2>
<p>
  Instances of <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpRequest.BodyPublisher.html">java.net.http.HttpRequest.BodyPublisher</a>
  are used to send request body content.
  The JDK HttpClient comes with a number of implementations for different situations. You can use your own implementation as well if you so desire.
</p>
<p>
  <em>avaje-http-client</em> adds URL encoded form and body adapters using Jackson and Gson
  to convert body content to/from JSON and java beans/types.
</p>

<h5>Request Body</h5>
<ul>
  <li>An Object that is written by the BodyAdapter, e.g. JsonbBodyAdapter writes as JSON content</li>
  <li>formParam() for url encoded form</li>
  <li>byte[], String, Path (file), InputStream</li>
  <li>Any <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpRequest.BodyPublishers.html">HttpRequest.BodyPublisher</a></li>
</ul>

<h3 id="req-json">Object as JSON</h3>
<p>
  When we create the HttpClient, we can register a message body handler. When these are registered, we can call <code>body(object)</code> to write the body content as JSON.
</p>

<h4>Example: POST object as json</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">Hello</span> <span class="n">bean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hello</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="s">&quot;rob&quot;</span><span class="o">,</span> <span class="s">&quot;hello world&quot;</span><span class="o">);</span>

<span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">bean</span><span class="o">)</span>
  <span class="o">.</span><span class="na">POST</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="req-formParam">formParam</h3>
<p>
  Calling <code>formParam()</code> adds URL encoded name-value pairs, and send body content as <code>application/x-www-form-urlencoded</code>.
</p>

<h4>Example: POST using formParams</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;register/user&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;Bazz&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="s">&quot;user@foo.com&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;url&quot;</span><span class="o">,</span> <span class="s">&quot;http://foo.com&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;startDate&quot;</span><span class="o">,</span> <span class="s">&quot;2020-12-03&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">POST</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="req-path">Path (file)</h3>
<p>
  This uses <code>HttpRequest.BodyPublishers.ofFile(file)</code> to
  stream file content as the request body.
</p>

<h4>Example: PUT file Path</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">Path</span> <span class="n">file</span> <span class="o">=</span> <span class="o">...;</span>
<span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;upload&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">file</span><span class="o">)</span>
  <span class="o">.</span><span class="na">PUT</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="req-inputStream">InputStream</h3>
<p>
  This uses <code>HttpRequest.BodyPublishers.ofInputStream(supplier)</code>
  to stream the request body content from the InputStream.
</p>

<h4>Example: PUT InputStream</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="o">...;</span>

<span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;upload&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">inputStream</span><span class="o">)</span>
  <span class="o">.</span><span class="na">PUT</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="req-bodyPublisher">HttpRequest.BodyPublisher</h3>
<p>
  We can pass any <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpRequest.BodyPublisher.html">HttpRequest.BodyPublisher</a>
  into <code>body()</code>. Refer to <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpRequest.BodyPublishers.html">HttpRequest.BodyPublishers</a>
  for ones that come with JDK HttpClient.
</p>

<h4>Example: Use any BodyPublisher</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;whazzzup&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">HttpRequest</span><span class="o">.</span><span class="na field">BodyPublishers</span><span class="o">.</span><span class="na">ofString</span><span class="o">(</span><span class="s">&quot;silly example&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="na">PUT</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
</pre></div>
</div>

<h4>Summary of default BodyPublishers</h4>
<table style="width:75%;">
  <tr><td>BodyPublishers.noBody()</td><td>Sends no request body.</td></tr>
  <tr><td>BodyPublishers.ofByteArray()</td><td>byte[]</td></tr>
  <tr><td>BodyPublishers.ofString()</td><td>String, additional charset option</td></tr>
  <tr><td>BodyPublishers.ofInputStream()</td><td>InputStream</td></tr>
  <tr><td>BodyPublishers.ofFile(Path file)</td><td>Path with various options</td></tr>
  <tr><td>BodyPublishers.fromPublisher(...)</td><td>various options</td></tr>
</table>

<h2 id="response-body">Response body</h2>
<p>
  <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpResponse.BodyHandler.html">java.net.http.HttpResponse.BodyHandler</a>
  is the interface used to handle response bodies. The JDK HttpClient provides a number of BodyHandlers including reactive Flow based subscribers.
</p>
<p>
  <em>avaje-http-client</em> has APIs to use the common ones such as String, Void, byte[] etc
  and <code>withHandler()</code> to use any BodyHandler implementation.
</p>

<h3 id="bean">bean(Class&lt;T&gt;)</h3>
<p>
  Return the response via BodyAdapter as a java bean/type (typically JSON). The BodyAdapter
  decodes from a <code>byte[]</code>. Gzip decoding occurs based on <em>Content-Encoding</em> header.
</p>
<p>
  If the HTTP status code is in the error range this throws an <a href="#httpException">HttpException</a>.
  From the HttpException we can get the underlying HttpResponse and error
  response body.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">Customer</span> <span class="n">customer</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;customers/42&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</div>

<h3 id="list">list(Class&lt;T&gt;)</h3>
<p>
  Return the response via BodyAdapter as a list of java beans/type (typically JSON). The BodyAdapter
  decodes from <code>byte[]</code>. Gzip decoding occurs based on <em>Content-Encoding</em> header.
</p>
<p>
  If the HTTP status code is in the error range this throws an <a href="#httpException">HttpException</a>.
  From the HttpException we can get the underlying HttpResponse and error
  response body.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">Customer</span><span class="o">&gt;</span> <span class="n">customers</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;customers&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</div>

<h3 id="stream">stream(Class&lt;T&gt;)</h3>
<p>
  Return the response via BodyAdapter as a stream of java beans/type.
  The response media type is expected to be <code>application/x-json-stream</code>.
  Internally this uses <code>HttpResponse.BodyHandlers.asLines()</code> to
  get a stream of lines <code>Stream&lt;String&gt;</code>. In this case the BodyAdapter
  decodes from <code>String</code> content and there is no gzip decoding supported.
</p>
<p>
  If the HTTP status code is in the error range this throws an <a href="#httpException">HttpException</a>.
  From the HttpException we can get the underlying HttpResponse and error response body.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Customer</span><span class="o">&gt;</span> <span class="n">customers</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;customers&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</div>


<h3 id="asVoid">asVoid()</h3>
<p>
  Return as <code>HttpResponse&lt;Void&gt;</code> but the response
  content is still available to be read in the case of error response.
</p>
<p>
  If the HTTP status code is in the error range this throws an <a href="#httpException">HttpException</a>.
  From the HttpException we can get the underlying HttpResponse and error
  response body.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="asDiscarding">asDiscarding()</h3>
<p>
  Return a <code>HttpResponse&lt;Void&gt;</code> but the response
  content is always discarded. Unlike <code>asVoid()</code>, error content will not be available.
</p>
<p>
  We use <em>asDiscarding()</em> when we only ever want the status code
  and headers etc and never want the response body.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asDiscarding</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="asString">asString()</h3>
<p>
  Return as <code>HttpResponse&lt;String&gt;</code>.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="as">as()</h3>
<p>
  Return as <code>HttpResponse&lt;T&gt;</code>.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">as</span><span class="o">(</span><span class="n">T</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</div>

<h3 id="withHandler">withHandler()</h3>
<p>
  Using <code>withHandler()</code> we can use any BodyHandler to process the response.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">InputStream</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
 <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello/stream&quot;</span><span class="o">)</span>
 <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
 <span class="o">.</span><span class="na">withHandler</span><span class="o">(</span><span class="n">BodyHandlers</span><span class="o">.</span><span class="na">ofInputStream</span><span class="o">());</span>
</pre></div>
</div>

<h4>Summary of default BodyHandlers</h4>
<table style="width:75%;">
  <tr><td>BodyHandlers.discarding()</td><td>Discards the response body</td></tr>
  <tr><td>BodyHandlers.ofByteArray()</td><td>byte[]</td></tr>
  <tr><td>BodyHandlers.ofString()</td><td>String, additional charset options</td></tr>
  <tr><td>BodyHandlers.ofLines()</td><td>Stream&lt;String&gt;</td></tr>
  <tr><td>BodyHandlers.ofInputStream()</td><td>InputStream</td></tr>
  <tr><td>BodyHandlers.ofFile(Path file)</td><td>Path with various options</td></tr>
  <tr><td>BodyHandlers.ofByteArrayConsumer(...)</td><td>&nbsp;</td></tr>
  <tr><td>BodyHandlers.fromSubscriber(...)</td><td>various options</td></tr>
  <tr><td>BodyHandlers.fromLineSubscriber(...)</td><td>various options</td></tr>
</table>


<h2 id="httpException">HttpException</h2>
<p>
  An <code>HttpException</code> is thrown when the status code is not in the 2XX range and the call is one of <a href="#bean">bean()</a>,
  <a href="#list">list()</a>, <a href="#stream">stream()</a>, <a href="#asVoid">asVoid()</a>.
</p>
<p>
  <code>HttpException</code> effectively wraps the <code>HttpResponse</code> and provides helper methods to get the response body
  as String, byte[] or bean (via the registered body adapter).
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">statusCode</span><span class="o">();</span>

<span class="c1">// the underlying HttpResponse</span>
<span class="n">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">httpResponse</span> <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">httpResponse</span><span class="o">()</span>
<span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">httpResponse</span><span class="o">.</span><span class="na">statusCode</span><span class="o">();</span>

<span class="c1">// helper methods to read the response body</span>
<span class="n">String</span> <span class="n">errorBodyString</span> <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">bodyAsString</span><span class="o">();</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">errorBodyBytes</span>  <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">bodyAsBytes</span><span class="o">();</span>

<span class="c1">// helper method to read the response body as a bean (typically using Jackson/Gson)</span>
<span class="n">MyErrorBean</span> <span class="n">errorResponse</span> <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">MyErrorBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</div>

<h3 id="error-mapping">Exception Mapping</h2>
<p>
  To automatically map <code>HttpException</code> into a custom exception you can provide a mapper function globally or per request.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
<span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="s">&quot;https://api.github.com&quot;</span><span class="o">)</span>
<span class="c1">//set a global mapper any http exceptions will be mapped using this function</span>
<span class="o">.</span><span class="na">globalErrorMapper</span><span class="o">(</span><span class="n">httpException</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">CustomException</span><span class="o">(</span><span class="n">httpException</span><span class="o">))</span>
<span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="c1">//can also set a mapper per request (will override the global one)</span>
<span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
      <span class="o">.</span><span class="na">errorMapper</span><span class="o">(</span><span class="n">httpException</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">CustomException</span><span class="o">(</span><span class="n">httpException</span><span class="o">))</span>
      <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
      <span class="o">.</span><span class="na">asPlainString</span><span class="o">();</span>
</pre></div>
</div>

<p>
  On request failure the function will receive the <code>HttpException</code> to be mapped into your custom exception and be rethrown.
</p>

<h4>Client Generation</h4>
  <p>
    If a method has a <code>throws</code> clause, and the exception has a constructor that takes a single <code>HttpException</code>, then the generated code will automatically register the contructor as an error mapper.
  </p>
  <p>
    Given the below exception and client interface:
  </p>
  <div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomException</span> <span class="kd">extends</span> <span class="n">RuntimeException</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="nf">CustomException</span><span class="o">(</span><span class="n">HttpException</span> <span class="n">httpException</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//process the exception (perhaps get the status code or response body)</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>
  <div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Client</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ApiClient</span> <span class="o">{</span>

  <span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/mapped&quot;</span><span class="o">)</span>
  <span class="n">String</span> <span class="nf">mapped</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">CustomException</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
  <p>
    The below implementation will be generated:
  </p>
  <div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Generated</span><span class="o">(</span><span class="s">&quot;avaje-http-client-generator&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiClientHttpClient</span> <span class="kd">implements</span> <span class="n">ApiClient</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">HttpClient</span> <span class="n">client</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">ApiClientHttpClient</span><span class="o">(</span><span class="n">HttpClient</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// GET /mapped</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">mapped</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
      <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;mapped&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">errorMapper</span><span class="o">(</span><span class="n">CustomException</span><span class="o">::</span><span class="k">new</span><span class="o">)</span> <span class="c1">// error mapper registered</span>
      <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
      <span class="o">.</span><span class="na">asPlainString</span><span class="o">().</span><span class="na">body</span><span class="o">();</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>

<h2 id="async">Async</h2>
<p>
  All requests can be made using <code>async</code> returning <code>CompletableFuture</code>.
  Commonly the <code>whenComplete()</code> callback will be used to process the async responses.
</p>
<p>
  The <em>bean()</em>, <em>list()</em>, <em>stream()</em> and <em>asVoid()</em> responses throw a
  <code><a href="#httpException">HttpException</a></code> if the status code is not in the 2XX range.
</p>
<p>
  Reference API javadoc <a target="_blank" href="/apidocs/avaje-http-client/io.avaje.http.client/io/avaje/http/client/HttpAsyncResponse.html">HttpAsyncResponse</a>
</p>

<h4>Example: async().asString()</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
 <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello/world&quot;</span><span class="o">)</span>
 <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
 <span class="o">.</span><span class="na">async</span><span class="o">().</span><span class="na">asString</span><span class="o">()</span>
 <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">hres</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="o">...</span>
   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
     <span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">hres</span><span class="o">.</span><span class="na">statusCode</span><span class="o">();</span>
     <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="n">hres</span><span class="o">.</span><span class="na">body</span><span class="o">();</span>
     <span class="o">...</span>
   <span class="o">}</span>
 <span class="o">});</span>
</pre></div>
</div>

<h4>Example: async().bean(Class&lt;T&gt;)</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
 <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;customer&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
 <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
 <span class="o">.</span><span class="na">async</span><span class="o">().</span><span class="na">bean</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
 <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">customer</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">HttpException</span> <span class="n">httpException</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpException</span><span class="o">)</span> <span class="n">throwable</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
     <span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">getStatusCode</span><span class="o">();</span>

     <span class="c1">// maybe convert json error response body to a bean (using Jackson/Gson)</span>
     <span class="n">MyErrorBean</span> <span class="n">errorResponse</span> <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">MyErrorBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
     <span class="o">..</span>

   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
     <span class="c1">// use customer</span>
     <span class="o">...</span>
   <span class="o">}</span>
 <span class="o">});</span>
</pre></div>
</div>

<h4>Example: async().withHandler()</h4>
<p>
  The example below is a line subscriber processing response content line by line.
</p>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
 <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello/lineStream&quot;</span><span class="o">)</span>
 <span class="o">.</span><span class="na">GET</span><span class="o">().</span><span class="na">async</span><span class="o">()</span>
 <span class="o">.</span><span class="na">withHandler</span><span class="o">(</span><span class="n">HttpResponse</span><span class="o">.</span><span class="na field">BodyHandlers</span><span class="o">.</span><span class="na">fromLineSubscriber</span><span class="o">(</span><span class="k">new</span> <span class="n">Flow</span><span class="o">.</span><span class="na">Subscriber</span><span class="o">&lt;&gt;()</span> <span class="o">{</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSubscribe</span><span class="o">(</span><span class="n">Flow</span><span class="o">.</span><span class="na">Subscription</span> <span class="n">subscription</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">subscription</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="n">String</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
     <span class="c1">// process the line of response content</span>
     <span class="o">...</span>
   <span class="o">}</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
     <span class="o">...</span>
   <span class="o">}</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="o">{</span>
     <span class="o">...</span>
   <span class="o">}</span>
 <span class="o">}))</span>
 <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">hres</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
   <span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">hres</span><span class="o">.</span><span class="na">statusCode</span><span class="o">();</span>
   <span class="o">...</span>
 <span class="o">});</span>
</pre></div>
</div>

<h3 id="async-join">Testing with async() and join()</h3>
<p>
  When writing tests using <code>.async()</code> we can use <code>.join()</code> such that the current
  thread waits for the async processing to complete. We then execute asserts knowing the async processing
  has completed.
</p>

<h4>Example: join()</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
 <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;customer&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
 <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
 <span class="o">.</span><span class="na">async</span><span class="o">().</span><span class="na">bean</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
 <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">customer</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
   <span class="o">...</span>
 <span class="o">}).</span><span class="na">join</span><span class="o">();</span> <span class="c1">// wait for async processing to complete</span>

<span class="c1">// can assert here after the join() if desired</span>
<span class="n">assertThat</span><span class="o">(...)</span>
</pre></div>
</div>

<h3 id="async-executor">Executor and common pool</h3>
<p>
  <a target="_blank" href="https://bugs.openjdk.java.net/browse/JDK-8204339">JDK-8204339 - HTTP Client Dependent tasks should run in the common pool</a>
  means that by <em>default</em>, async callbacks are executed using the <code>ForkJoinPool.commonPool()</code> even when an
  <code>Executor</code> is assigned to the <code>HttpClient</code>. This can be unexpected behavior, also refer
  to this <a href="https://stackoverflow.com/questions/51907641/java-11-http-client-asynchronous-execution">stackoverflow discussion</a>
  on this behavior.
</p>
<p></p>


<h2 id="httpCall">HttpCall</h2>
<p>
  If we are creating an API and want the client code to <em>choose</em> to execute
  the request asynchronously or synchronously then we can use <code>call()</code>.
  This is similar to <em>Retrofit Call</em> for people who are familiar with that.
</p>
<p>
  The client can then choose to <em>execute()</em> the request synchronously or
  choose <em>async()</em> to execute the request asynchronously.
</p>
<p>
  Reference API javadoc <a target="_blank" href="/apidocs/avaje-http-client/io.avaje.http.client/io/avaje/http/client/HttpCall.html">HttpCall</a>
</p>

<h4>Example: call()</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpCall</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Customer</span><span class="o">&gt;&gt;</span> <span class="n">call</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;customers&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">call</span><span class="o">().</span><span class="na">list</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// Either execute synchronously</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Customer</span><span class="o">&gt;</span> <span class="n">customers</span> <span class="o">=</span>  <span class="n">call</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>

<span class="c1">// Or execute asynchronously</span>
<span class="n">call</span><span class="o">.</span><span class="na">async</span><span class="o">()</span>
  <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">customers</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="o">...</span>
  <span class="o">});</span>
</pre></div>
</div>

<h2 id="retry">Retry</h2>
<p>
  To add Retry funtionality, use <code>.retryHandler(yourhandler)</code> on the builder to provide your retry handler.
</p>
<p>
  The RetryHandler interface provides two methods, one for status exceptions (e.g. you get a 4xx/5xx from the server) and another for exceptions thrown by the underlying client (e.g. server times out or client couldn't send request).
  <br></br>Here is example implementation of RetryHandler.
</p>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ExampleRetry</span> <span class="kd">implements</span> <span class="n">RetryHandler</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAX_RETRIES</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isRetry</span><span class="o">(</span><span class="kt">int</span> <span class="n">retryCount</span><span class="o">,</span> <span class="n">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="k">var</span> <span class="n">code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">statusCode</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">retryCount</span> <span class="o">&gt;=</span> <span class="n">MAX_RETRIES</span> <span class="o">||</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="mi">400</span><span class="o">)</span> <span class="o">{</span>

      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isExceptionRetry</span><span class="o">(</span><span class="kt">int</span> <span class="n">retryCount</span><span class="o">,</span> <span class="n">HttpException</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//unwrap the exception</span>
    <span class="kd">final</span> <span class="k">var</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">retryCount</span> <span class="o">&gt;=</span> <span class="n">MAX_RETRIES</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="n">ConnectException</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>
</pre></div>
</div>

<h2 id="auth">Authorization</h2>
<p>
  <em>avaje-http-client</em> has built in support for <a href="#auth-basic">basic auth</a> and
  <a href="#auth-bearer">bearer token</a> based authorisation.
</p>

<h3 id="auth-basic">Basic Auth</h3>
<p>
  We can use <a target="_blank" href="/apidocs/avaje-http-client/io.avaje.http.client/io/avaje/http/client/BasicAuthIntercept.html"><code>BasicAuthIntercept</code></a>
  to intercept all requests adding a <code>Authorization: Basic ...</code> header.
</p>

<h4>Example</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="n">baseUrl</span><span class="o">)</span>
  <span class="o">...</span>
  <span class="o">.</span><span class="na">requestIntercept</span><span class="o">(</span><span class="k">new</span> <span class="n">BasicAuthIntercept</span><span class="o">(</span><span class="s">&quot;myUsername&quot;</span><span class="o">,</span> <span class="s">&quot;myPassword&quot;</span><span class="o">))</span>  <span class="o">&lt;!--</span> <span class="n">HERE</span>
  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>


<h3 id="auth-bearer">Bearer token Authorization - AuthTokenProvider</h3>
<p>
  For Authorization using <em>Bearer</em> tokens that are obtained and expire after some time, implement
  <a target="_blank" href="/apidocs/avaje-http-client/io.avaje.http.client/io/avaje/http/client/AuthTokenProvider.html"><code>AuthTokenProvider</code></a>
  and register that when building the HttpClient.
</p>

<h4>Step 1. Implement AuthTokenProvider</h4>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">MyAuthTokenProvider</span> <span class="kd">implements</span> <span class="n">AuthTokenProvider</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AuthToken</span> <span class="nf">obtainToken</span><span class="o">(</span><span class="n">HttpClientRequest</span> <span class="n">tokenRequest</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">MyAuthTokenResponse</span> <span class="n">res</span> <span class="o">=</span> <span class="n">tokenRequest</span>
      <span class="o">.</span><span class="na">url</span><span class="o">(</span><span class="s">&quot;https://foo/v2/token&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;content-type&quot;</span><span class="o">,</span> <span class="s">&quot;application/json&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">authRequestAsJson</span><span class="o">())</span>
      <span class="o">.</span><span class="na">POST</span><span class="o">()</span>
      <span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">MyAuthTokenResponse</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="n">Instant</span> <span class="n">validUntil</span> <span class="o">=</span> <span class="n">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusSeconds</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">expiresIn</span><span class="o">()).</span><span class="na">minusSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">AuthToken</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">accessToken</span><span class="o">(),</span> <span class="n">validUntil</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>

<h4>Step 2. Register with HttpClient</h4>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="s">&quot;https://foo&quot;</span><span class="o">)</span>
  <span class="o">...</span>
  <span class="o">.</span><span class="na">authTokenProvider</span><span class="o">(</span><span class="k">new</span> <span class="n">MyAuthTokenProvider</span><span class="o">())</span> <span class="o">&lt;!--</span> <span class="n">HERE</span>
  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>

<h4>Token will be obtained and set automatically</h4>
<p>
  All requests using the HttpClient will automatically get
  an <em>Authorization</em> header with the retrived<em>Bearer</em> token added. The token will be
  obtained for the initial request and then renewed when the token has expired.
</p>


<h2 id="logging">Logging</h2>
<p>
  By default request response logging is built in (via <code>RequestLogger</code>)
  and we enable it via setting the log level to <code>DEBUG</code> or <code>TRACE</code>
  for <code>io.avaje.http.client.RequestLogger</code>
</p>
<h5>Example: Logback</h5>
<div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;io.avaje.http.client.RequestLogger&quot;</span> <span class="na">level=</span><span class="s">&quot;trace&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>

<h4 id="logging-summary">DEBUG</h4>
<p>
  Summary logging that includes the response status code and execution time is logged
  at <code>DEBUG</code> level.
</p>
<h4 id="logging-detail">TRACE</h4>
<p>
  Logging that includes the request and response <em>headers</em> plus the <em>body</em>
  content is logged at <code>TRACE</code> level.
</p>

<h3>Suppression</h3>
<p>
  Logging is suppressed for <em>Authorization</em> headers and requests used by
  <a href="#auth-bearer">AuthTokenProvider</a>. Additionally logging can be
  suppressed on requests via <code>HttpClientRequest.suppressLogging()</code>.
</p>



<h2 id="client-api">Client API</h2>
<p>
  We can define an interface and have the implementation generated. Similar to
  JAX-RS Client, Retrofit, Feign.
</p>
<p>
  When using Client API we need to add a dependency for <em>avaje-http-api</em>
  which has the annotations and also add the annotation processor <em>avaje-http-client-generator</em>.
</p>
<h3>Getting started</h3>
<p>
  Goto <a href="start#api-start">Getting started with Client API</a> for step by step
  instructions to get started.
</p>

<h3 id="at-client">@Client</h3>
<p>
  If we are creating the interface we can put <code>@Client</code> on the interface
  to indicate that the generator should generate an implementation for it.
</p>

<h5>Example client API</h5>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Client</span>
<span class="kd">interface</span> <span class="nc">GitHub</span> <span class="o">{</span>

  <span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/repos/{owner}/{repo}/contributors&quot;</span><span class="o">)</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Contributor</span><span class="o">&gt;</span> <span class="nf">contributors</span><span class="o">(</span><span class="n">String</span> <span class="n">owner</span><span class="o">,</span> <span class="n">String</span> <span class="n">repo</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>

<h3 id="at-client-import">@Client.Import</h3>
<p>
  If the interface is already defined (in say another project) then we can instead
  use <code>@Client.Import</code> to indicate to the generator that it should
  generate an implementation for the interface defined by <code>@Client.Import</code>.
</p>
<p>
  We can put the <code>@Client.Import</code> on a <code>package-info</code> or any type.
  Most commonly we would put it on the top level <em>package-info</em>.
</p>

<h5>Example client import</h5>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Client.Import</span><span class="o">(</span><span class="nx">types</span> <span class="o">=</span> <span class="nx">org</span><span class="o">.</span><span class="na field">foo</span><span class="o">.</span><span class="na field">MyInterface</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kn">package</span> <span class="nn">org.bar</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.avaje.http.api.Client</span><span class="o">;</span>
</pre></div>
</div>

<h3 id="obtain-api">Obtain/use API</h3>
<p>
  We obtain the API implementation via <code>httpClient.create(T)</code> passing
  our client interface type <em>T</em>.
</p>

<h4 id="client-create">Example: obtain implementation</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">final</span> <span class="n">HttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="s">&quot;https://api.github.com&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">bodyAdapter</span><span class="o">(</span><span class="k">new</span> <span class="n">JsonbBodyAdapter</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="c1">// obtain API implementation</span>
<span class="kd">final</span> <span class="n">Github</span> <span class="n">github</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">Github</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// use it</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Contributor</span><span class="o">&gt;</span> <span class="n">contributors</span> <span class="o">=</span> <span class="n">github</span><span class="o">.</span><span class="na">contributors</span><span class="o">(</span><span class="s">&quot;ebean-orm&quot;</span><span class="o">,</span> <span class="s">&quot;ebean&quot;</span><span class="o">);</span>
</pre></div>
</div>

<h3 id="generated-api">Generated implementation</h3>
<p>
  The <em>avaje-http-client-generator</em> annotation processor generates the
  implementation as java source code. The generated source is typically found in:
  <code>target/generated-sources/annotations</code>
</p>
<img src="/images/http-client-api-sources.png" width="400px">

<p>&nbsp;</p>
<p>
  For more on <a href="/http-client/start#B3">IntelliJ IDEA</a> setup of generated source.
</p>

<p>&nbsp;</p>
<h3>Example: Generated source</h3>
<p>
  The generated code for the <code>Github</code> interface above is:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.httpclient</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">io.avaje.http.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.avaje.http.client.HttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.example.Contributor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.example.Github</span><span class="o">;</span>

<span class="nd">@Generated</span><span class="o">(</span><span class="s">&quot;avaje-http-client-generator&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Github&#36;HttpClient</span> <span class="kd">implements</span> <span class="n">Github</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">HttpClient</span> <span class="n">clientContext</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Github&#36;HttpClient</span><span class="o">(</span><span class="n">HttpClient</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">clientContext</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// GET /repos/{owner}/{repo}/contributors</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Contributor</span><span class="o">&gt;</span> <span class="nf">contributors</span><span class="o">(</span><span class="n">String</span> <span class="n">owner</span><span class="o">,</span> <span class="n">String</span> <span class="n">repo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
      <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;repos&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="n">owner</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="n">repo</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;contributors&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
      <span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Contributor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>

<h3 id="api-response-types">Response types</h3>
<p>
  Below is a table of the API response types can be used and the resulting generated code.
</p>
<table style="width: 100%;">
  <tr>
    <th style="width: 50%;">Method response type</th>
    <th>Generated code</th>
  </tr>

  <tr><td>void</td><td>asVoid()</td></tr>
  <tr><td>String</td><td>asPlainString().body()</td></tr>

  <tr><td>T</td><td>bean(T.class)</td></tr>
  <tr><td>List&lt;T&gt;</td><td>list(T.class)</td></tr>
  <tr><td>Stream&lt;T&gt;</td><td>stream(T.class)</td></tr>
  <tr><td>HttpResponse&lt;Void&gt;</td><td>asVoid()</td></tr>
  <tr><td>HttpResponse&lt;String&gt;</td><td>asString()</td></tr>
  <tr><td>HttpResponse&lt;T&gt;</td><td>as(T.class)</td></tr>
  <tr><td>HttpResponse&lt;byte[]&gt;</td><td>asByteArray()</td></tr>
  <tr><td>HttpResponse&lt;InputStream&gt;</td><td>asInputStream()</td></tr>
  <tr><td>HttpResponse&lt;Stream&lt;String&gt;&gt;</td><td>asLines()</td></tr>
  <tr><td>&nbsp;</td><td>&nbsp;</td></tr>


  <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
<!--  <tr><td><b>CompletableFuture</b></td><td>&nbsp;</td></tr>-->

  <tr><td>CompletableFuture&lt;T&gt;</T></td><td>async().bean(T.class)</td></tr>
  <tr><td>CompletableFuture&lt;List&lt;T&gt;&gt;</td><td>async().list(T.class)</td></tr>
  <tr><td>CompletableFuture&lt;Stream&lt;T&gt;&gt;</td><td>async().stream(T.class)</td></tr>

  <tr><td>CompletableFuture&lt;HttpResponse&lt;Void&gt;&gt;</td><td>async().asVoid()</td></tr>
  <tr><td>CompletableFuture&lt;HttpResponse&lt;String&gt;&gt;</td><td>async().asString()</td></tr>
  <tr><td>CompletableFuture&lt;HttpResponse&lt;T&gt;&gt;</td><td>async().as(T.class)</td></tr>
  <tr><td>CompletableFuture&lt;HttpResponse&lt;byte[]&gt;&gt;</td><td>async().asByteArray()</td></tr>
  <tr><td>CompletableFuture&lt;HttpResponse&lt;InputStream&gt;&gt;</td><td>async().asInputStream()</td></tr>
  <tr><td>CompletableFuture&lt;HttpResponse&lt;Stream&lt;String&gt;&gt;&gt;</td><td>async().asLines()</td></tr>

  <tr><td>&nbsp;</td><td>&nbsp;</td></tr>
<!--  <tr><td><b>HttpCall</b></td><td>&nbsp;</td></tr>-->

  <tr><td>HttpCall&lt;T&gt;</T></td><td>call().bean(T.class)</td></tr>
  <tr><td>HttpCall&lt;List&lt;T&gt;&gt;</td><td>call().list(T.class)</td></tr>
  <tr><td>HttpCall&lt;Stream&lt;T&gt;&gt;</td><td>call().stream(T.class)</td></tr>

  <tr><td>HttpCall&lt;HttpResponse&lt;Void&gt;&gt;</td><td>call().asVoid()</td></tr>
  <tr><td>HttpCall&lt;HttpResponse&lt;String&gt;&gt;</td><td>call().asString()</td></tr>
  <tr><td>HttpCall&lt;HttpResponse&lt;T&gt;&gt;</td><td>call().as(T.class)</td></tr>
  <tr><td>HttpCall&lt;HttpResponse&lt;byte[]&gt;&gt;</td><td>call().asByteArray()</td></tr>
  <tr><td>HttpCall&lt;HttpResponse&lt;InputStream&gt;&gt;</td><td>call().asInputStream()</td></tr>
  <tr><td>HttpCall&lt;HttpResponse&lt;Stream&lt;String&gt;&gt;&gt;</td><td>call().asLines()</td></tr>

</table>

<h3 id="api-response-body">HttpResponse.BodyHandler parameter</h3>
<p>
  The method can also declare one parameter of type <code>java.net.http.HttpResponse.BodyHandler</code>
  and this will be used to handle the response body. This can be a specific generic type like
  <code>BodyHandler&lt;Path&gt;</code> or more general type like <code>BodyHandler&lt;T&gt;</code>.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/{id}&quot;</span><span class="o">)</span>
<span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="nf">getWithHandler</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">HttpResponse</span><span class="o">.</span><span class="na">BodyHandler</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">myHandler</span><span class="o">,</span> <span class="n">String</span> <span class="n">other</span><span class="o">);</span>
</pre></div>
</div>
<p>
  The generated code uses the BodyHandler parameter to handle the response body. The resulting generated code
  includes <code>.withHandler(myHandler)</code>:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// GET /{id}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="nf">getWithHandler</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">BodyHandler</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">myHandler</span><span class="o">,</span> <span class="n">String</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
    <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;other&quot;</span><span class="o">,</span> <span class="n">other</span><span class="o">)</span>
    <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
    <span class="o">.</span><span class="na">withHandler</span><span class="o">(</span><span class="n">myHandler</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<p>
  We can also use a more general handler like <code>HttpResponse.BodyHandler&lt;T&gt;</code>.
  For example:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/{id}&quot;</span><span class="o">)</span>
<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">getWithGeneralHandler</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">HttpResponse</span><span class="o">.</span><span class="na">BodyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">myHandler</span><span class="o">);</span>
</pre></div>
</div>
<p>
  The generated code uses the BodyHandler parameter to handle the response body.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// GET /{id}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">getWithGeneralHandler</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">BodyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">myHandler</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
    <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
    <span class="o">.</span><span class="na">withHandler</span><span class="o">(</span><span class="n">myHandler</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>

<h3 id="api-request-body">HttpRequest.BodyPublisher parameter</h3>
<p>
  The method can also declare one parameter of type <code>java.net.http.HttpRequest.BodyPublisher</code>
  and this will be used for the request body.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Post</span><span class="o">(</span><span class="s">&quot;/{id}/foo/{name}&quot;</span><span class="o">)</span>
<span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">postWithBody</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">HttpRequest</span><span class="o">.</span><span class="na">BodyPublisher</span> <span class="n">body</span><span class="o">);</span>
</pre></div>
</div>
<p>
  The generated code uses the BodyPublisher parameter as the request body <code>.body(body)</code>
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// POST /{id}/foo/{name}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">postWithBody</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">BodyPublisher</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
    <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">body</span><span class="o">)</span>
    <span class="o">.</span><span class="na">POST</span><span class="o">()</span>
    <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>

<h3 id="path">@Path</h3>
<p>
  We can optionally put <code>@Path</code> on the interface type. This path is prefixed to the
  paths defined on the verb annotations <code>@Get, @Post, @Put ...</code>.
</p>
<p>
  For example, with <code>@Path("/api/cats")</code> all the paths defined have <code>/api/cats</code> prefixed.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Client</span>
<span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/api/cats&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Cats</span> <span class="o">{</span>

  <span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;{id}&quot;</span><span class="o">)</span>
  <span class="n">Cat</span> <span class="nf">byId</span><span class="o">(</span><span class="n">UUID</span> <span class="n">id</span><span class="o">);</span>

  <span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;{id}/operations&quot;</span><span class="o">)</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Operation</span><span class="o">&gt;</span> <span class="nf">operations</span><span class="o">(</span><span class="n">UUID</span> <span class="n">id</span><span class="o">,</span> <span class="n">OffsetDateTime</span> <span class="n">since</span><span class="o">);</span>

  <span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;all&quot;</span><span class="o">)</span>
  <span class="n">Stream</span><span class="o">&lt;</span><span class="n">Cat</span><span class="o">&gt;</span> <span class="nf">all</span><span class="o">();</span>

  <span class="nd">@Post</span>
  <span class="kt">void</span> <span class="nf">create</span><span class="o">(</span><span class="n">Cat</span> <span class="n">cat</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<p>
  The generated paths for the methods above all have <code>/api/cats</code> prefix:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// GET {id}</span>
<span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;cats&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>

<span class="c1">// GET {id}/operations</span>
<span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;cats&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;operations&quot;</span><span class="o">)</span>

<span class="c1">// GET all</span>
<span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;cats&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;all&quot;</span><span class="o">)</span>

<span class="c1">// POST</span>
<span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;cats&quot;</span><span class="o">)</span>
</pre></div>
</div>

<h3 id="pathParameters">Path parameters</h3>
<p>
  Path parameters start with <code>{</code> and end with <code>}</code> and matched
  to method parameter names. So unlike JAX-RS we do not need a <code>@PathParam</code>
  annotation.
</p>
<p>
  For example <code>{id}</code>, <code>{startDate}</code>, <code>{type}</code>
  in the path are matched to method parameters of the same name.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/{id}/{startDate}/{type}&quot;</span><span class="o">)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Bazz</span><span class="o">&gt;</span> <span class="nf">findBazz</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">,</span> <span class="n">LocalDate</span> <span class="n">startDate</span><span class="o">,</span> <span class="n">String</span> <span class="n">type</span><span class="o">);</span>
</pre></div>
</div>
<p>
  The generated code includes <code>.path(id).path(startDate).path(type)</code>:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// GET /{id}/{startDate}/{type}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Bazz</span><span class="o">&gt;</span> <span class="nf">findBazz</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">,</span> <span class="n">LocalDate</span> <span class="n">startDate</span><span class="o">,</span> <span class="n">String</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="n">startDate</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="n">type</span><span class="o">)</span>
    <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
    <span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Bazz</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<p>
  Unlike JAX-RS we do not need a <code>@PathParam</code> annotation.
</p>

<h3 id="timeout">@RequestTimeout</h3>
<p>
  Use <code>@RequestTimeout</code> to override the global response timout for a specific request.
 </p>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Client</span>
<span class="kd">interface</span> <span class="nc">CustomerApi</span> <span class="o">{</span>
  <span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/{id}&quot;</span><span class="o">)</span>
  <span class="nd">@RequestTimeout</span><span class="o">(</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="nx">ChronoUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span> <span class="c1">//defaults to milliseceonds</span>
  <span class="n">Customer</span> <span class="nf">getById</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>

<h3 id="header">@Header</h3>
<p>
  Use <code>@Header</code> for a header parameter.
  It the header parameter name is not explicitly specified then
  it is the <em>init caps snake case</em> of the parameter name.
</p>
<p>
  <code>userAgent</code> -> <code>User-Agent</code>
</p>
<p>
  <code>lastModified</code> -> <code>Last-Modified</code>
</p>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Post</span>
<span class="nx">Bar</span> <span class="nf">postIt</span><span class="o">(</span><span class="nx">Foo</span> <span class="nx">payload</span><span class="o">,</span> <span class="nd">@Header</span><span class="o">(</span><span class="s">&quot;User-Agent&quot;</span><span class="o">)</span> <span class="nx">String</span> <span class="nx">userAgent</span><span class="o">);</span> <span class="c1">// explicit</span>

<span class="nd">@Post</span>
<span class="nx">Bar</span> <span class="nf">postIt</span><span class="o">(</span><span class="nx">Foo</span> <span class="nx">payload</span><span class="o">,</span> <span class="nd">@Header</span> <span class="nx">String</span> <span class="nx">userAgent</span><span class="o">);</span> <span class="c1">// User-Agent</span>

<span class="nd">@Post</span>
<span class="nx">Bar</span> <span class="nf">postIt</span><span class="o">(</span><span class="nx">Foo</span> <span class="nx">payload</span><span class="o">,</span> <span class="nd">@Header</span> <span class="nx">Collection</span><span class="o">&lt;</span><span class="nx">String</span><span class="o">&gt;</span> <span class="nx">accept</span><span class="o">);</span> <span class="c1">// Accept</span>

<span class="nd">@Get</span>
<span class="nx">Bazz</span> <span class="nf">find</span><span class="o">(</span><span class="nd">@Header</span> <span class="nx">String</span> <span class="nx">lastModified</span><span class="o">);</span> <span class="c1">// Last-Modified</span>
</pre></div>
</div>

<h4>@Header Map&lt;String, ?&gt;</h4>
<p>
  We can use <code>@Header</code> with a <code>Map&lt;String, ?&gt;</code>, <code>Map&lt;String, String&gt;</code>
  or <code>Map&lt;String, Object&gt;</code>.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;{type}&quot;</span><span class="o">)</span>
<span class="nx">List</span><span class="o">&lt;</span><span class="nx">Cat</span><span class="o">&gt;</span> <span class="nf">searchByType</span><span class="o">(</span><span class="nx">String</span> <span class="nx">type</span><span class="o">,</span> <span class="nx">String</span> <span class="nx">query</span><span class="o">,</span> <span class="nd">@Header</span> <span class="nx">Map</span><span class="o">&lt;</span><span class="nx">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="nx">myHeaders</span><span class="o">);</span>
</pre></div>
</div>
<p>
  The generated code includes <code>.header(myHeaders)</code>
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// GET {type}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cat</span><span class="o">&gt;</span> <span class="nf">searchByType</span><span class="o">(</span><span class="n">String</span> <span class="n">type</span><span class="o">,</span> <span class="n">String</span> <span class="n">query</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,?&gt;</span> <span class="n">myHeaders</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">myHeaders</span><span class="o">)</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;cats&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="n">type</span><span class="o">)</span>
    <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;query&quot;</span><span class="o">,</span> <span class="n">query</span><span class="o">)</span>
    <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
    <span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>

<h3 id="queryParam">@QueryParam</h3>
<p>
  We explicitly specify query parameters using <code>@QueryParam</code>.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// Explicit query parameter order-by</span>

<span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/{bornAfter}&quot;</span><span class="o">)</span>
<span class="nx">List</span><span class="o">&lt;</span><span class="nx">Cat</span><span class="o">&gt;</span> <span class="nf">findCats</span><span class="o">(</span><span class="nx">LocalDate</span> <span class="nx">bornAfter</span><span class="o">,</span> <span class="nd">@QueryParam</span><span class="o">(</span><span class="s">&quot;order-by&quot;</span><span class="o">)</span> <span class="nx">String</span> <span class="nx">orderBy</span><span class="o">);</span>
</pre></div>
</div>
<p>
  The generated code includes <code>.queryParam("order-by", orderBy)</code>
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// GET /{bornAfter}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cat</span><span class="o">&gt;</span> <span class="nf">findCats</span><span class="o">(</span><span class="n">LocalDate</span> <span class="n">bornAfter</span><span class="o">,</span> <span class="n">String</span> <span class="n">orderBy</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="n">bornAfter</span><span class="o">)</span>
    <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;order-by&quot;</span><span class="o">,</span> <span class="n">orderBy</span><span class="o">)</span>
    <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
    <span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<h4>Implied query parameters</h4>
<p>
  Query parameters can be <em>implied</em> by not being a path parameter.
  That is, if a method parameter does not match a path parameter then it is
  implied to be a query parameter.
</p>
<p>
  The following 3 declarations are exactly the same with all 3 having
  a query parameters for <code>orderBy</code>
</p>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/{bornAfter}&quot;</span><span class="o">)</span>
<span class="nx">List</span><span class="o">&lt;</span><span class="nx">Cat</span><span class="o">&gt;</span> <span class="nf">findCats</span><span class="o">(</span><span class="nx">LocalDate</span> <span class="nx">bornAfter</span><span class="o">,</span> <span class="nd">@QueryParam</span><span class="o">(</span><span class="s">&quot;orderBy&quot;</span><span class="o">)</span> <span class="nx">String</span> <span class="nx">orderBy</span><span class="o">);</span>

<span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/{bornAfter}&quot;</span><span class="o">)</span>
<span class="nx">List</span><span class="o">&lt;</span><span class="nx">Cat</span><span class="o">&gt;</span> <span class="nf">findCats</span><span class="o">(</span><span class="nx">LocalDate</span> <span class="nx">bornAfter</span><span class="o">,</span> <span class="nd">@QueryParam</span> <span class="nx">String</span> <span class="nx">orderBy</span><span class="o">);</span>

<span class="nd">@Post</span><span class="o">(</span><span class="s">&quot;/{bornAfter}&quot;</span><span class="o">)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Cat</span><span class="o">&gt;</span> <span class="nf">findCats</span><span class="o">(</span><span class="n">LocalDate</span> <span class="n">bornAfter</span><span class="o">,</span> <span class="n">String</span> <span class="n">orderBy</span><span class="o">);</span>  <span class="c1">// orderBy implied as query parameter</span>
</pre></div>
</div>

<p>
  We must explicitly use <code>@QueryParam</code> when the query parameter
  is not a valid java identifier. For example, if the query parameter includes a hyphen
  then we must use <code>@QueryParam</code> explicitly.
</p>

<h4>@QueryParam Map&lt;String, ?&gt;</h4>
<p>
  We can use <code>@QueryParam</code> with a <code>Map&lt;String, ?&gt;</code>, <code>Map&lt;String, String&gt;</code>
  or <code>Map&lt;String, Object&gt;</code>
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Post</span>
<span class="kt">void</span> <span class="nf">newCat</span><span class="o">(</span><span class="nx">Cat</span> <span class="nx">cat</span><span class="o">,</span> <span class="nx">String</span> <span class="nx">myParam</span><span class="o">,</span> <span class="nd">@QueryParam</span> <span class="nx">Map</span><span class="o">&lt;</span><span class="nx">String</span><span class="o">,?&gt;</span> <span class="nx">extraParams</span><span class="o">);</span>
</pre></div>
</div>
<p>
  The generated code includes <code>.queryParam(extraParams)</code>
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// POST</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">newCat</span><span class="o">(</span><span class="n">Cat</span> <span class="n">cat</span><span class="o">,</span> <span class="n">String</span> <span class="n">myParam</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,?&gt;</span> <span class="n">extraParams</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;cats&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;myParam&quot;</span><span class="o">,</span> <span class="n">myParam</span><span class="o">)</span>
    <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="n">extraParams</span><span class="o">)</span>
    <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">cat</span><span class="o">)</span>
    <span class="o">.</span><span class="na">POST</span><span class="o">()</span>
    <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>

<h3 id="bodystring">@BodyString</h3>
  We can specify that a string parameter is a body using <code>@BodyString</code>.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Post</span><span class="o">(</span><span class="s">&quot;/stringbody&quot;</span><span class="o">)</span>
<span class="nx">List</span><span class="o">&lt;</span><span class="nx">Cat</span><span class="o">&gt;</span> <span class="nf">addCats</span><span class="o">(</span><span class="nd">@BodyString</span> <span class="nx">String</span> <span class="nx">body</span><span class="o">);</span>
</pre></div>
</div>
<p>The generated code will be:</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cat</span><span class="o">&gt;</span> <span class="nf">addCats</span><span class="o">(</span><span class="n">String</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;stringbody&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">body</span><span class="o">)</span>
    <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
    <span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>

<h3 id="beanParam">@BeanParam</h3>
<p>
  When we have a lot of query parameters or if we have query parameters
  that are common to many endpoints then we look to use <code>@BeanParam</code>.
</p>
<p>
  We can create a bean and all the properties on the bean default to being
  query parameters and annotate this with <code>@BeanParam</code>.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">record</span> <span class="nf">Common</span><span class="o">(</span>
  <span class="n">Long</span> <span class="n">firstRow</span><span class="o">,</span>
  <span class="n">Long</span> <span class="n">maxRows</span><span class="o">,</span>
  <span class="n">String</span> <span class="n">sortBy</span><span class="o">,</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">filters</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>
</pre></div>
</div>
<p>
  Use a record type or any type that has getter methods, record style getter methods or public fields.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Common</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">Long</span> <span class="n">firstRow</span><span class="o">;</span>
  <span class="kd">public</span> <span class="n">Long</span> <span class="n">maxRows</span><span class="o">;</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="n">sortBy</span><span class="o">;</span>
  <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">filters</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>
  We annotate the method parameter with <code>@BeanParam</code>
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;search/{type}&quot;</span><span class="o">)</span>
<span class="nx">List</span><span class="o">&lt;</span><span class="nx">Cat</span><span class="o">&gt;</span> <span class="nf">searchCats</span><span class="o">(</span><span class="nx">String</span> <span class="nx">type</span><span class="o">,</span> <span class="nd">@BeanParam</span> <span class="nx">Common</span> <span class="nx">commonParams</span><span class="o">);</span>
</pre></div>
</div>
<p>
  Generated code has <code>queryParam()</code> for each of the properties:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// GET search/{type}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cat</span><span class="o">&gt;</span> <span class="nf">searchCats</span><span class="o">(</span><span class="n">String</span> <span class="n">type</span><span class="o">,</span> <span class="n">Common</span> <span class="n">commonParams</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;search&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="n">type</span><span class="o">)</span>
    <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;firstRow&quot;</span><span class="o">,</span> <span class="n">commonParams</span><span class="o">.</span><span class="na">firstRow</span><span class="o">())</span>
    <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;maxRows&quot;</span><span class="o">,</span> <span class="n">commonParams</span><span class="o">.</span><span class="na">maxRows</span><span class="o">())</span>
    <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;sortBy&quot;</span><span class="o">,</span> <span class="n">commonParams</span><span class="o">.</span><span class="na">sortBy</span><span class="o">())</span>
    <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;filters&quot;</span><span class="o">,</span> <span class="n">commonParams</span><span class="o">.</span><span class="na">filters</span><span class="o">())</span>
    <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
    <span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>

<h4>JAX-RS @BeanParam</h4>
<p>
  Our <em>@BeanParam</em> is the same as JAX-RS <em>@BeanParam</em> except the properties
  default to being query parameters. With JAX-RS we need to explicitly annotate each of the properties.
  We can do this because we also have <a href="#form">@Form</a> and "Form beans".
</p>

<h4>BeanParam with @Header properties</h4>
<p>
  The properties on a "bean" default to being query parameters. We put
  <a href="#header">@Header</a> on properties that are instead headers.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">record</span> <span class="nf">Common</span><span class="o">(</span>
  <span class="n">Long</span> <span class="n">firstRow</span><span class="o">,</span>
  <span class="n">Long</span> <span class="n">maxRows</span><span class="o">,</span>
  <span class="n">String</span> <span class="n">sortBy</span><span class="o">,</span>
  <span class="n">String</span> <span class="n">filter</span><span class="o">,</span>
  <span class="nd">@Header</span><span class="o">(</span><span class="s">&quot;X-Mod&quot;</span><span class="o">)</span>
  <span class="n">String</span> <span class="n">modification</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>
</pre></div>
</div>
<p>
  We then get the <code>modification</code> value set as a <em>header</em>.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;X-Mod&quot;</span><span class="o">,</span> <span class="n">commonParams</span><span class="o">.</span><span class="na">modification</span><span class="o">())</span>
</pre></div>
</div>


<h3 id="form">@Form</h3>
<p>
  If a method has both <code>@Post</code> and <code>@Form</code> then the
  method parameters default to be form parameters.
</p>
<p>
  In the following example name, email and url all default to be form parameters.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Form</span> <span class="nd">@Post</span><span class="o">(</span><span class="s">&quot;register&quot;</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">,</span> <span class="n">String</span> <span class="n">url</span><span class="o">);</span>
</pre></div>
</div>
<p>
  The generated code includes <code>.formParam()</code> for <em>name, email and url</em>.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// POST register</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">,</span> <span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;register&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="n">name</span><span class="o">)</span>
    <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="n">email</span><span class="o">)</span>
    <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;url&quot;</span><span class="o">,</span> <span class="n">url</span><span class="o">)</span>
    <span class="o">.</span><span class="na">POST</span><span class="o">()</span>
    <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>

<h3 id="formParam">@FormParam</h3>
<p>
  For the example above we could alternatively use explicit <code>@FormParam</code>
  on each of the form parameters rather than <code>@Form</code>. We then get:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Post</span><span class="o">(</span><span class="s">&quot;register&quot;</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="nd">@FormParam</span> <span class="nx">String</span> <span class="nx">name</span><span class="o">,</span> <span class="nd">@FormParam</span> <span class="nx">String</span> <span class="nx">email</span><span class="o">,</span> <span class="nd">@FormParam</span> <span class="nx">String</span> <span class="nx">url</span><span class="o">);</span>
</pre></div>
</div>
<p>
  The expectation is that we most often would use <code>@Form</code> because it reduces
  "annotation noise" and that we will very rarely use <code>@FormParam</code>. Potentially
  we only use @FormParam if the parameter name includes hyphen or similar characters that
  are not valid Java/Kotlin identifiers.
</p>

<h4>@FormParam Map&lt;String, ?&gt;</h4>
<p>
  We can use <code>@FormParam</code> with a <code>Map&lt;String, ?&gt;</code>, <code>Map&lt;String, String&gt;</code>
  or <code>Map&lt;String, Object&gt;</code>.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Put</span><span class="o">(</span><span class="s">&quot;{id}&quot;</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="nx">UUID</span> <span class="nx">id</span><span class="o">,</span> <span class="nd">@FormParam</span> <span class="nx">Map</span><span class="o">&lt;</span><span class="nx">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="nx">params</span><span class="o">);</span>
</pre></div>
</div>
<p>
  The generated code includes <code>.formParam(params)</code>
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// PUT {id}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">UUID</span> <span class="n">id</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,?&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;cats&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
    <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="n">params</span><span class="o">)</span>
    <span class="o">.</span><span class="na">PUT</span><span class="o">()</span>
    <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>

<h2 id="formBeans">@Form "Form Beans"</h2>
<p>
  In the case where we are posting a form with a lot of parameters we can define a bean with
  properties for each of the form parameters rather than have a method with lots of arguments.
</p>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">record</span> <span class="nf">RegisterForm</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">email</span><span class="o">,</span> <span class="n">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>
</pre></div>
</div>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="nd">@Form</span> <span class="nd">@Post</span><span class="o">(</span><span class="s">&quot;register&quot;</span><span class="o">)</span>
<span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">RegisterForm</span> <span class="n">myForm</span><span class="o">);</span>
</pre></div>
</div>
The generated code for the above is:
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// POST register</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">RegisterForm</span> <span class="n">myForm</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;register&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="n">myForm</span><span class="o">.</span><span class="na">name</span><span class="o">())</span>
    <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="n">myForm</span><span class="o">.</span><span class="na">email</span><span class="o">())</span>
    <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;url&quot;</span><span class="o">,</span> <span class="n">myForm</span><span class="o">.</span><span class="na">url</span><span class="o">())</span>
    <span class="o">.</span><span class="na">POST</span><span class="o">()</span>
    <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>
<p>
  "Form beans" are nice with large forms because they help de-clutter our code
  and the generated code takes care of putting the values into our bean properties so that
  we don't have to write.
</p>
<p>
  This use of <em>@Form</em> is very similar to JAX-RS <em>@BeanParam</em> except that the
  bean properties default be being form parameters. With JAX-RS we would put a <code>@FormParam</code>
  on every property that is a form parameter which becomes a lot of annotation noise on a large form.
</p>

<h4>Form beans with @QueryParam, @Header properties</h4>
<p>
  The properties on a "form bean" default to being form parameters. We put <em>@QueryParam</em>,
  <em>@Header</em> on properties that are instead query params, headers or cookies.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">record</span> <span class="nf">RegisterForm</span><span class="o">(</span>
  <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
  <span class="n">String</span> <span class="n">email</span><span class="o">,</span>
  <span class="n">String</span> <span class="n">url</span><span class="o">,</span>
  <span class="nd">@QueryParam</span> <span class="nx">Boolean</span> <span class="nx">overrideFlag</span><span class="o">,</span>
  <span class="nd">@Header</span> <span class="nx">String</span> <span class="nx">xModified</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>
</pre></div>
</div>
<p>
  The generated code includes <code>queryParam()</code> and <code>header()</code> for
  those parameters:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// POST register</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">RegisterForm</span> <span class="n">myForm</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;register&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="n">myForm</span><span class="o">.</span><span class="na">name</span><span class="o">())</span>
    <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="n">myForm</span><span class="o">.</span><span class="na">email</span><span class="o">())</span>
    <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;url&quot;</span><span class="o">,</span> <span class="n">myForm</span><span class="o">.</span><span class="na">url</span><span class="o">())</span>
    <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">&quot;overrideFlag&quot;</span><span class="o">,</span> <span class="n">myForm</span><span class="o">.</span><span class="na">overrideFlag</span><span class="o">())</span>
    <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;X-Modified&quot;</span><span class="o">,</span> <span class="n">myForm</span><span class="o">.</span><span class="na">xModified</span><span class="o">())</span>
    <span class="o">.</span><span class="na">POST</span><span class="o">()</span>
    <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>

<h2 id="jpms">@Client Java Module Setup</h2>
<p>
  If using java modules with generated Client Interfaces, in the <code>module-info.java</code> we need to:
</p>
<ol>
  <li>Add a <em>requires</em> clause for <em>io.avaje.http.api</em></li>
  <li>Add a <em>requires</em> clause for <em>io.avaje.http.client</em></li>
  <li>Add a <em>provides</em> clause for <em>io.avaje.http.client.HttpClient.GeneratedComponent</em></li>
</ol>

<h5>Example module-info</h5>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io.avaje.http.client.HttpClient.GeneratedComponent</span>
<span class="n">module</span> <span class="n">org</span><span class="o">.</span><span class="na">example</span> <span class="o">{</span>

  <span class="n">requires</span> <span class="n">io</span><span class="o">.</span><span class="na field">avaje</span><span class="o">.</span><span class="na field">http</span><span class="o">.</span><span class="na">api</span><span class="o">;</span>
  <span class="n">requires</span> <span class="n">io</span><span class="o">.</span><span class="na field">avaje</span><span class="o">.</span><span class="na field">http</span><span class="o">.</span><span class="na">client</span>
  <span class="c1">// you must define the fully qualified class name of the generated classes. if you use an import statement, compilation will fail</span>
  <span class="n">provides</span> <span class="n">GeneratedComponent</span> <span class="n">with</span> <span class="n">org</span><span class="o">.</span><span class="na field">example</span><span class="o">.</span><span class="na">GeneratedHttpComponent</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>
 In the example above, <code>org.example.GeneratedHttpComponent</code> is generated code typically found in
  <code>target/generated-sources/annotations</code>.
</p>

<h2 id="10k">10K requests - Loom vs Async</h2>
<p>
  The following is a very quick and rough comparison of running 10,000 requests
  using <em>Async</em> vs <em>Loom</em>.
</p>
<p>
  The intention is to test the thought that in a "future Loom world" the
  desire to use <code>async()</code> execution with HttpClient reduces.
</p>
<p>
  TLDR: Caveat, caveat, more caveats ... initial testing shows Loom to be just a
  touch faster (~10%) than async.
</p>
<p>
  To run my tests I use <a target="_blank" href="https://github.com/avaje/avaje-jex">Jex</a> as the server
  (Jetty based) and have it running using Loom. For whatever testing you do
  you will need a server that can handle a very large number of concurrent requests.
</p>
<p>
  The Loom blocking request (make 10K of these)
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span>  <span class="n">httpClient</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;s200&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">();</span>
</pre></div>
</div>
<p>
  The equivalent async request (make 10K of these joining the CompletableFuture's).
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;s200&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">async</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">()</span>
  <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">hres</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="o">...</span>
  <span class="o">});</span>
</pre></div>
</div>

<h3 id="10k-async">10K requests using Async and reactive streams</h3>
<p>
  Use <code>.async()</code> to execute the requests which internally is using JDK
  HttpClient's reactive streams. The <code>whenComplete()</code> callback is invoked
  when the response is ready. Collect all the resulting CompletableFuture
  and wait for them all to complete.
</p>
<p>
Outline:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// Collect all the CompletableFuture&#39;s</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10_000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
  <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">httpClient</span><span class="o">.</span><span class="na">request</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;s200&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
    <span class="o">.</span><span class="na">async</span><span class="o">().</span><span class="na">asString</span><span class="o">()</span>
    <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">hres</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="c1">// confirm 200 response etc</span>
        <span class="o">...</span>
    <span class="o">}));</span>
<span class="o">}</span>

<span class="c1">// wait for all requests to complete via join() ...</span>
<span class="n">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="n">futures</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">CompletableFuture</span><span class="o">[</span><span class="mi">0</span><span class="o">])).</span><span class="na">join</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="10k-loom">10K requests using Loom</h3>
<p>
  With Loom Java 17 EA Release we can use <code>Executors.newVirtualThreadExecutor()</code>
  to return an ExecutorService that uses Loom Virtual Threads. These are backed
  by "Carrier threads" (via ForkedJoinPool).
</p>
<p>
Outline:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// use Loom&#39;s Executors.newVirtualThreadExecutor()</span>
<span class="k">try</span> <span class="o">(</span><span class="n">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newVirtualThreadExecutor</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10_000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">task</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">task</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span>
    <span class="n">httpClient</span><span class="o">.</span><span class="na">request</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;s200&quot;</span><span class="o">)</span>
     <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
     <span class="o">.</span><span class="na">asString</span><span class="o">();</span>

  <span class="c1">// confirm 200 response etc</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>
Caveat: Proper performance benchmarks are really hard and take a lot of effort.
</p>
<p>
  Running some "rough/approx performance comparison tests" using <em>Loom</em>
  build <code>17 EA 2021-09-14 / (build 17-loom+7-342)</code> vs <em>Async</em> for my environment
  and 10K request scenarios has loom execution around 10% faster than async.
</p>
<p>
  It looks like Loom and Async run in pretty much the same time although it
  currently looks that Loom is just a touch faster (perhaps due to how it does
  park/unpark). More investigation required.
</p>
<p>
  Date: 2021-06 <br/>
  Build: <code>17 EA 2021-09-14 / (build 17-loom+7-342)</code>.
</p>
<pre>
  openjdk version "17-loom" 2021-09-14
  OpenJDK Runtime Environment (build 17-loom+7-342)
  OpenJDK 64-Bit Server VM (build 17-loom+7-342, mixed mode, sharing)
</pre>


  </article>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="/js/site.js"></script>
</body>
</html>
